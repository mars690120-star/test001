<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç¾©å¤§ç™Œæ²»ç™‚é†«é™¢é–€è¨ºç”¨è—¥æŒ‡å°æœå‹™æ»¿æ„åº¦å•å·</title>

<!--
README (ç°¡çŸ­èªªæ˜)
- æœ¬ single-file HTML å¯ç›´æ¥æ”¾åˆ°éœæ…‹ç¶²é ä¼ºæœå™¨é‹ä½œï¼ˆç„¡ä¼ºæœå™¨ç«¯ä¾è³´ï¼‰ã€‚
- ä¾è³´å¤–éƒ¨å¥—ä»¶ (CDN)ï¼š
  1) html2canvas: https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js
  2) jsPDF:      https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js
  3) SheetJS:   https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js
  è‹¥éœ€é›¢ç·šä½¿ç”¨ï¼šä¸‹è¼‰ä¸Šè¿° JS æª”ä¸¦å°‡ <script src="..."> æ”¹ç‚ºæœ¬æ©Ÿè·¯å¾‘ï¼ˆä¾‹å¦‚ ./libs/html2canvas.min.jsï¼‰ã€‚
- è³‡æ–™è™•ç†å®Œå…¨åœ¨ä½¿ç”¨è€…ç«¯ï¼ˆlocalStorage / ä¸‹è¼‰ JSON / åŒ¯å‡º PDF/Excelï¼‰ã€‚**ä¸å¾—åŠ å…¥ä»»ä½•è‡ªå‹•ä¸Šå‚³ç¨‹å¼**ã€‚ç¨‹å¼ç¢¼å…§äº¦æœ‰è¨»è§£æé†’æ­¤é …ã€‚
- ç¶­è­·è—¥å¸«/è—¥å“æ¸…å–®ï¼šç®¡ç†æŒ‰éˆ•æœƒé–‹å•Ÿ modalï¼Œæ“ä½œçµæœå„²å­˜åœ¨ localStorageï¼ˆmedSurvey_pharmacistsã€medSurvey_medsï¼‰ã€‚
- åŒ¯å‡ºæª”åç¤ºç¯„ï¼šsurvey_{è¡›æ•™ç·¨è™Ÿ}_{æ—¥æœŸ}.pdf / .xlsxã€‚
-->

<style>
:root{
  --primary-blue:#0b67a3;
  --tech-green:#17b978;
  --tech-gray:#9aa3a8;
  --bg:#f7f9fb;
  --card-bg:#ffffff;
  --accent-grad: linear-gradient(90deg,var(--primary-blue),var(--tech-green));
  --focus-ring: 0 0 0 3px rgba(23,185,120,0.12);
  --gap:12px;
  --radius:10px;
}
*{box-sizing:border-box}
body{
  margin:0;font-family: "Noto Sans TC","Segoe UI",Roboto,Arial;
  background:var(--bg);color:#123;line-height:1.45;
}
.container{max-width:980px;margin:24px auto;padding:18px;}
.card{background:var(--card-bg);border-radius:var(--radius);padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.04);border:1px solid rgba(0,0,0,0.04);}
.header{display:flex;flex-direction:column;gap:10px;margin-bottom:8px;}
.top-row{display:flex;justify-content:space-between;align-items:center;}
.lang-wrap{display:flex;gap:10px;align-items:center;}
.title{display:flex;flex-direction:column;align-items:center;}
h1{margin:0;font-size:20px;color:var(--primary-blue);}
.subtitle{color:#235064;font-size:13px;margin-top:8px;text-align:center;}
.edu-number{font-size:13px;color:#234;}

/* form */
form{margin-top:12px;}
.grid{display:grid;gap:12px;}
.row-2{grid-template-columns:1fr 1fr;}
.row-3{grid-template-columns:1fr 1fr 1fr;}
.full{grid-column:1/-1;}
label.field{display:block;font-weight:700;color:#123;margin-bottom:6px;font-size:13px;}
input[type="text"], input[type="tel"], input[type="date"], select, textarea{
  width:100%;padding:9px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;font-size:14px;
}
textarea{min-height:80px;resize:vertical}
input:focus, textarea:focus, select:focus{box-shadow:var(--focus-ring);outline:none;border-color:var(--tech-green);}
.muted{font-size:12px;color:var(--tech-gray);}

/* radio/checkbox custom */
.radios{display:flex;gap:8px;flex-wrap:wrap;}
.radio-btn{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:transparent;}
.radio-circle{width:18px;height:18px;border-radius:50%;border:2px solid rgba(0,0,0,0.12);display:inline-block;flex-shrink:0;}
.radio-circle.checked{background:linear-gradient(90deg,var(--primary-blue),var(--tech-green));border-color:transparent;}
.checkbox-circle{width:18px;height:18px;border-radius:6px;border:2px solid rgba(0,0,0,0.12);display:inline-block;flex-shrink:0;}
.checkbox-circle.checked{background:linear-gradient(90deg,var(--primary-blue),var(--tech-green));border-color:transparent;}
.question{display:flex;gap:12px;align-items:flex-start;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.03);}

/* pre/post tags */
.tag-pre{color:var(--primary-blue);font-weight:800}
.tag-post{color:var(--tech-green);font-weight:800}

/* signature */
.signature-area{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;}
.sig-box{padding:10px;border-radius:8px;border:1px dashed rgba(0,0,0,0.08);background:#fff;}
canvas{border-radius:6px;background:#fff;touch-action:none;}
.sig-controls{display:flex;flex-direction:column;gap:8px;min-width:180px;font-size:13px}

/* bottom actions */
.actions{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:12px;}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;}
.btn:focus{outline:none;box-shadow:var(--focus-ring)}
.btn-save{background:var(--tech-green);color:#fff}
.btn-load{background:#e03b3b;color:#fff}
.btn-reset{background:#cfd6d8;color:#123}
.btn-primary{background:var(--primary-blue);color:#fff}
.icon{width:18px;height:18px;display:inline-block}

/* error */
.error{color:#d32f2f;font-size:13px;margin-top:6px;display:none}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#fff;padding:16px;border-radius:8px;max-width:680px;width:100%;box-shadow:0 6px 24px rgba(0,0,0,0.2)}
.modal .list{max-height:260px;overflow:auto}

/* responsive */
@media (max-width:880px){
  .row-2,.row-3{grid-template-columns:1fr}
  .top-row{flex-direction:column;align-items:stretch;gap:8px}
}
</style>
</head>
<body>
  <div class="container">
    <div class="card" id="mainCard" role="main">
      <div class="header">
        <div class="top-row">
          <div class="lang-wrap">
            <label class="muted" for="langSel" id="langLabel">è«‹é¸æ“‡èªè¨€(Select Language)</label>
            <select id="langSel" aria-label="Select Language"></select>
          </div>
          <div class="edu-number" aria-live="polite">è¡›æ•™ç·¨è™Ÿï¼š <strong id="eduNumber">______</strong></div>
        </div>

        <div class="title">
          <div style="display:flex;align-items:center;gap:10px;">
            <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2L2 7v6c0 5 3.8 9.7 10 11 6.2-1.3 10-6 10-11V7l-10-5z"/></svg>
            <h1 id="mainTitle">ç¾©å¤§ç™Œæ²»ç™‚é†«é™¢é–€è¨ºç”¨è—¥æŒ‡å°æœå‹™æ»¿æ„åº¦å•å·</h1>
          </div>
          <div class="subtitle" id="greeting">
            å„ä½å…ˆç”Ÿã€å¥³å£«ï¼šæ‚¨å¥½ï¼ç™Œæ²»ç™‚é†«é™¢è—¥åŠ‘ç§‘ç‚ºèƒ½æå‡æ›´å¥½çš„æœå‹™å“è³ªèˆ‡é¡§å®¢æ»¿æ„åº¦ï¼Œæ•¬è«‹æ‚¨å”åŠ©å¡«å¯«ä¸‹åˆ—è³‡æ–™ä¸¦æä¾›æ‚¨çš„å¯¶è²´æ„è¦‹ï¼Œä»¥ä¾›æˆ‘å€‘åƒè€ƒèˆ‡æ”¹é€²ã€‚<br>æ•¬ç¥ å¹³å®‰ã€€ç™Œæ²»ç™‚é†«é™¢è—¥åŠ‘ç§‘é—œå¿ƒæ‚¨
          </div>
        </div>
      </div>

      <form id="surveyForm" novalidate>
        <!-- patient basic -->
        <section class="card" style="margin-bottom:12px;">
          <div class="grid row-2">
            <div>
              <label class="field">å¡«å¯«è€… <span class="muted">(å¿…å¡«)</span></label>
              <div style="display:flex;gap:10px;align-items:center;">
                <label class="radio-btn"><input type="radio" name="filledBy" value="patient" checked> ç—…äººæœ¬äºº</label>
                <label class="radio-btn"><input type="radio" name="filledBy" value="proxy"> ä»£å¡«</label>
                <input id="proxyRelation" type="text" placeholder="é—œä¿‚ï¼šä¾‹å¦‚ å­/é…å¶" style="display:none" aria-label="ä»£ç†äººé—œä¿‚">
              </div>
            </div>
            <div>
              <label class="field">ç—…æ­·è™Ÿ/èº«åˆ†è­‰è™Ÿ <span class="muted">(å¿…å¡«)</span></label>
              <input id="mrn" type="text" placeholder="åƒ…å…è¨± A-Z åŠ 0-9" aria-describedby="mrnHelp">
              <div id="mrnErr" class="error">å¿…å¡«ï¼æœªå®Œæˆ</div>
              <div id="mrnHelp" class="muted">è¼¸å…¥è‹±æ•¸å­—ï¼ˆA-Z åŠ 0-9ï¼‰ï¼Œç³»çµ±æœƒåŒæ­¥åˆ°è¡›æ•™ç·¨è™Ÿã€‚</div>
            </div>

            <div class="full">
              <div class="grid row-3">
                <div>
                  <label class="field">å§“åï¼ˆç—…äººï¼‰ <span class="muted">(å¿…å¡«)</span></label>
                  <input id="patientName" type="text" placeholder="ç—…äººå§“å">
                  <div id="nameErr" class="error">å¿…å¡«ï¼æœªå®Œæˆ</div>
                </div>
                <div>
                  <label class="field">è¯çµ¡é›»è©± <span class="muted">(å¿…å¡«)</span></label>
                  <input id="contactPhone" type="tel" placeholder="+8869XXXXXXXX">
                  <div id="phoneErr" class="error">æ ¼å¼éŒ¯èª¤ï¼ˆæœ€å°‘ 6 ç¢¼ï¼‰</div>
                </div>
                <div>
                  <label class="field">æ•™è‚²ç¨‹åº¦</label>
                  <select id="education">
                    <option value="">-- é¸æ“‡ --</option>
                    <option>å°å­¸</option><option>åœ‹ä¸­</option><option>é«˜ä¸­</option><option>å¤§(å°ˆ)</option><option>ç¢©å£«ä»¥ä¸Š</option><option>ä¸è­˜å­—</option>
                  </select>
                </div>
              </div>
            </div>

            <div>
              <label class="field">è¡›æ•™èªè¨€é¸æ“‡</label>
              <select id="teachLang"></select>
            </div>

            <div>
              <label class="field">ç—…æ­·/èº«åˆ†è­‰ é¡å‹æç¤º</label>
              <div class="muted">ç³»çµ±åƒ…æ¥å—è‹±æ–‡å­—æ¯èˆ‡æ•¸å­—ï¼›è¼¸å…¥æ™‚æœƒè‡ªå‹•ç§»é™¤éå…è¨±å­—å…ƒã€‚</div>
            </div>
          </div>
        </section>

        <!-- pharmacist block -->
        <section class="card" style="margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;gap:8px;align-items:center">
              <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a5 5 0 0 1 5 5v3h2v2h-2v6a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3v-6H3v-2h2V7a5 5 0 0 1 5-5z"/></svg>
              <strong>è¡›æ•™è—¥å¸«è³‡è¨Š</strong>
            </div>
            <div>
              <button type="button" class="btn btn-outline" id="managePharmacistsBtn" aria-label="ç®¡ç†è—¥å¸«">ç®¡ç†è—¥å¸«</button>
            </div>
          </div>

          <div class="grid row-2" style="margin-top:12px;">
            <div>
              <label class="field">è¡›æ•™è—¥å¸«å§“å <span class="muted">(å®Œæˆæ™‚å¿…å¡«)</span></label>
              <select id="pharmacistSelect"><option value="">-- é¸æ“‡è—¥å¸« --</option></select>
              <div id="pharmacistErr" class="error">å¿…å¡«ï¼æœªå®Œæˆ</div>
            </div>
            <div>
              <label class="field">è¡›æ•™æ—¥æœŸ</label>
              <input id="eduDate" type="date">
            </div>
          </div>
        </section>

        <!-- meds -->
        <section class="card" style="margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;gap:8px;align-items:center">
              <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a5 5 0 0 0-5 5v10a5 5 0 0 0 5 5 5 5 0 0 0 5-5V7a5 5 0 0 0-5-5z"/></svg>
              <strong>è¡›æ•™è—¥å“</strong>
            </div>
            <div>
              <button type="button" class="btn btn-outline" id="manageMedsBtn">ç®¡ç†è—¥å“</button>
            </div>
          </div>
          <div id="medListWrap" style="margin-top:12px"></div>
        </section>

        <!-- cognition -->
        <section class="card" style="margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:8px">
            <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 12h18M3 6h18M3 18h18"/></svg>
            <strong>è—¥ç‰©èªçŸ¥è©•ä¼°ï¼ˆèªçŸ¥åº¦ï¼‰</strong>
          </div>
          <div class="muted" style="margin-top:8px">æ¯é¡Œè«‹é¸ã€Œè¡›æ•™å‰ã€èˆ‡ã€Œè¡›æ•™å¾Œã€å…©æ™‚é»</div>
          <div id="cognitionArea" style="margin-top:10px"></div>
        </section>

        <!-- satisfaction -->
        <section class="card" style="margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:8px">
            <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2z"/></svg>
            <strong>æ»¿æ„åº¦èª¿æŸ¥ï¼ˆæ»¿æ„åº¦ï¼‰</strong>
          </div>

          <p class="muted" style="margin-top:8px">
            ç‚ºäº†ç¢ºä¿ç”¨è—¥å®‰å…¨èˆ‡æœå‹™å“è³ªï¼Œæœ¬é™¢å¯èƒ½æœƒåœ¨æ‚¨æ¥å—è¡›æ•™å¾Œé€²è¡Œé›»è©±è¿½è¹¤è¨ªè«‡ã€‚æ‰€æœ‰è³‡æ–™å°‡åƒ…ç”¨æ–¼é†«ç™‚å“è³ªæ”¹å–„ï¼Œä¸¦ä¾æ“šå€‹äººè³‡æ–™ä¿è­·æ³•åš´æ ¼ä¿å¯†ã€‚æ„Ÿè¬æ‚¨çš„é…åˆã€‚
          </p>

          <div id="satisfactionArea" style="margin-top:10px"></div>
        </section>

        <!-- signature & privacy -->
        <section class="card" style="margin-bottom:12px;">
          <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
            <div style="flex:1">
              <label class="field">ç—…äººï¼ä»£å¡«è€…æ‰‹å¯«ç°½å <span class="muted">(å¿…å¡«)</span></label>
              <div class="signature-area">
                <div class="sig-box" style="flex:1;">
                  <canvas id="sigCanvas" width="800" height="300" style="width:100%;height:150px;"></canvas>
                  <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
                    <button type="button" id="clearSigBtn" class="btn btn-outline">æ¸…é™¤ç°½å</button>
                    <label style="font-size:13px;" class="muted">ç­†åˆ·å¤§å°
                      <input id="brushSize" type="range" min="1" max="6" value="2" style="vertical-align:middle;margin-left:8px">
                    </label>
                    <div id="sigPreview" class="muted" style="margin-left:auto">å°šæœªç°½å</div>
                    <div id="sigErr" class="error">å¿…å¡«ï¼æœªå®Œæˆ</div>
                  </div>
                </div>

                <div style="flex-basis:320px;">
                  <label class="field">ã€å€‹äººè³‡æ–™ä¿è­·è²æ˜ã€‘</label>
                  <div class="muted" style="font-size:13px;line-height:1.4">
                    æœ¬å•å·æ‰€è’é›†ä¹‹å€‹äººè³‡æ–™ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼ç—…æ­·è™Ÿã€å§“åã€è¯çµ¡é›»è©±åŠç°½åï¼‰ï¼Œå°‡ä¾æ“šå€‹äººè³‡æ–™ä¿è­·æ³•åŠç›¸é—œæ³•ä»¤è¦å®šï¼Œåƒ…ä¾›æœ¬é™¢ã€Œæå‡é–€è¨ºç”¨è—¥æŒ‡å°æœå‹™å“è³ªã€ã€ã€Œå­¸è¡“ç ”ç©¶ã€åŠã€Œè¡Œæ”¿ç®¡ç†ã€ç­‰ç‰¹å®šç›®çš„ç¯„åœå…§è™•ç†åŠåˆ©ç”¨ã€‚é™¤ç¶“æ‚¨æ›¸é¢åŒæ„å¤–ï¼Œæœ¬é™¢ä¸æœƒå°‡æ‚¨çš„å€‹äººè³‡æ–™ç”¨æ–¼å…¶ä»–ç›®çš„æˆ–æä¾›äºˆä»»ä½•ç¬¬ä¸‰æ–¹ã€‚æ‚¨æœ‰æ¬Šå‘æœ¬é™¢æŸ¥è©¢ã€è«‹æ±‚é–±è¦½ã€è¤‡è£½ã€è£œå……ã€æ›´æ­£ã€åœæ­¢è’é›†ã€è™•ç†ã€åˆ©ç”¨æˆ–åˆªé™¤æ‚¨çš„å€‹äººè³‡æ–™ã€‚è‹¥æ‚¨ä¸é¡˜æä¾›ï¼Œå°‡å¯èƒ½å½±éŸ¿æœ¬é™¢æä¾›æ‚¨å®Œæ•´ä¹‹ç”¨è—¥æŒ‡å°æœå‹™ã€‚
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- actions -->
        <div class="actions">
          <div style="display:flex;gap:8px;">
            <button type="button" id="saveDraftBtn" class="btn btn-save" aria-label="æš«å­˜è‰ç¨¿" title="æš«å­˜è‰ç¨¿">ğŸ’¾ æš«å­˜è‰ç¨¿</button>
            <button type="button" id="openDraftBtn" class="btn btn-load" aria-label="é–‹å•Ÿè‰ç¨¿" title="é–‹å•Ÿè‰ç¨¿">ğŸ“‚ é–‹å•Ÿè‰ç¨¿</button>
            <input id="openDraftFile" type="file" accept="application/json" style="display:none" />
          </div>

          <div style="display:flex;gap:8px;">
            <button type="button" id="resetBtn" class="btn btn-reset" aria-label="é‡ç½®è¡¨å–®">â†º é‡ç½®</button>
            <button type="button" id="exportBtn" class="btn btn-primary" aria-label="å®Œæˆä¸¦åŒ¯å‡º">âœ… å®Œæˆ</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- modals -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" style="display:none">
    <div class="modal" id="modalContent"></div>
  </div>

<!-- External libraries (CDN). è‹¥åœ¨é›¢ç·š/å…§ç¶²ç’°å¢ƒï¼Œè«‹å°‡ä»¥ä¸‹ä¸‰å€‹ <script> æ›æˆæœ¬æ©Ÿè·¯å¾‘ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ------------------------
  é‡è¦å®‰å…¨è¨»è¨˜ï¼ˆè«‹å‹¿ç§»é™¤ï¼‰
  - æœ¬æª”æ¡ˆä¸æœƒè‡ªå‹•æŠŠä»»ä½•ç—…äººè³‡æ–™ä¸Šå‚³åˆ°ç¬¬ä¸‰æ–¹ä¼ºæœå™¨ã€‚
  - æ‰€æœ‰å„²å­˜ / åŒ¯å‡ºå‡åœ¨ä½¿ç”¨è€…ç«¯åŸ·è¡Œï¼ˆlocalStorage / æª”æ¡ˆä¸‹è¼‰ / PDF / Excelï¼‰ã€‚
  - è‹¥è¦ä¸²æ¥å¾Œç«¯ï¼Œå‹™å¿…é¡¯è‘—æç¤ºä¸¦å–å¾—ç—…æ‚£åŒæ„ï¼Œä¸¦ä½¿ç”¨å®‰å…¨å‚³è¼¸èˆ‡æˆæ¬Šã€‚
-------------------------*/

/* Localization */
const localeStrings = {
  "zh-TW": {
    langLabel: "è«‹é¸æ“‡èªè¨€(Select Language)",
    mainTitle: "ç¾©å¤§ç™Œæ²»ç™‚é†«é™¢é–€è¨ºç”¨è—¥æŒ‡å°æœå‹™æ»¿æ„åº¦å•å·",
    greeting: "å„ä½å…ˆç”Ÿã€å¥³å£«ï¼šæ‚¨å¥½ï¼ç™Œæ²»ç™‚é†«é™¢è—¥åŠ‘ç§‘ç‚ºèƒ½æå‡æ›´å¥½çš„æœå‹™å“è³ªèˆ‡é¡§å®¢æ»¿æ„åº¦ï¼Œæ•¬è«‹æ‚¨å”åŠ©å¡«å¯«ä¸‹åˆ—è³‡æ–™ä¸¦æä¾›æ‚¨çš„å¯¶è²´æ„è¦‹ï¼Œä»¥ä¾›æˆ‘å€‘åƒè€ƒèˆ‡æ”¹é€²ã€‚æ•¬ç¥ å¹³å®‰ã€€ç™Œæ²»ç™‚é†«é™¢è—¥åŠ‘ç§‘é—œå¿ƒæ‚¨",
    pre: "è¡›æ•™å‰", post: "è¡›æ•™å¾Œ",
    cognitionQs: [
      "1. æ‚¨æ˜¯å¦çŸ¥é“æ­¤è—¥ç‰©çš„ä½œç”¨ï¼Ÿ",
      "2. æ‚¨æ˜¯å¦æœƒä½¿ç”¨æˆ–æ“ä½œè©²è—¥ç‰©ï¼Ÿ",
      "3. æ‚¨æ˜¯å¦çŸ¥é“è©²è—¥ç‰©ä½¿ç”¨æ™‚çš„æ³¨æ„äº‹é …ï¼Ÿ"
    ],
    satisfactionQs: [
      "1. æ‚¨å°æœ¬é™¢æä¾›æ­¤ç”¨è—¥æŒ‡å°æœå‹™æµç¨‹æ»¿æ„å—ï¼Ÿ",
      "2. æ‚¨å°è—¥å¸«çš„æœå‹™æ…‹åº¦æ»¿æ„å—ï¼Ÿ",
      "3. ä¸‹æ¬¡è‹¥æœ‰ç”¨è—¥ç›¸é—œå•é¡Œï¼Œæ‚¨æœƒä¸æœƒå†è©¢å•è—¥å¸«ï¼Ÿ",
      "4. ç›®å‰çš„ç”¨è—¥ï¼Œæ‚¨æ˜¯å¦é¡˜æ„è—¥å¸«ç‚ºæ‚¨é€²è¡Œå¾ŒçºŒçš„é›»è¨ªè¿½è¹¤ï¼Ÿ"
    ],
    cognitionOptions: ["éå¸¸æ¸…æ¥š","æ¸…æ¥š","å°šå¯","ä¸æ¸…æ¥š","éå¸¸ä¸æ¸…æ¥š"],
    satisfactionOptions: ["éå¸¸æ»¿æ„","æ»¿æ„","ç„¡æ„è¦‹","ä¸æ»¿æ„","éå¸¸ä¸æ»¿æ„"],
    yes: "æœƒ", no: "ä¸æœƒ", other: "å…¶ä»–å¯¶è²´æ„è¦‹",
    agreeFollowUp: "é¡˜æ„", disagreeFollowUp: "ä¸é¡˜æ„",
    followUpTime: "é›»è¨ªæ™‚é–“", morning: "ä¸Šåˆ", afternoon: "ä¸‹åˆ", otherTime: "å…¶ä»–",
    contactPerson: "è¯çµ¡äºº",
    required: "å¿…å¡«ï¼æœªå®Œæˆ",
    exportChoose: "è«‹é¸æ“‡åŒ¯å‡ºæ ¼å¼ï¼šç¢ºå®š=PDFï¼Œå–æ¶ˆ=Excelï¼ˆå¯åˆ†é–‹é‡è¤‡åŒ¯å‡ºï¼‰"
  },
  "en-US": {
    langLabel: "Select Language",
    mainTitle: "E-Da Cancer Treatment Hospital Medication Counseling Survey",
    greeting: "Dear Sir/Madam: The Pharmacy Department seeks to improve service quality. Please fill the questionnaire. Best wishes, Pharmacy Department.",
    pre: "Before", post: "After",
    cognitionQs: [
      "1. Do you know the function of this medication?",
      "2. Can you use or operate this medication?",
      "3. Are you aware of precautions when using this medication?"
    ],
    satisfactionQs: [
      "1. Are you satisfied with the counseling workflow?",
      "2. Are you satisfied with the pharmacist's attitude?",
      "3. Will you ask the pharmacist again for medication-related issues?",
      "4. Are you willing to receive follow-up phone call about your medication?"
    ],
    cognitionOptions: ["Very clear","Clear","Okay","Not clear","Very unclear"],
    satisfactionOptions: ["Very satisfied","Satisfied","No opinion","Dissatisfied","Very dissatisfied"],
    yes: "Yes", no: "No", other: "Other comments",
    agreeFollowUp: "Agree", disagreeFollowUp: "Disagree",
    followUpTime: "Follow-up Time", morning: "Morning", afternoon: "Afternoon", otherTime: "Other",
    contactPerson: "Contact Person",
    required: "Required / Incomplete",
    exportChoose: "Choose export format: OK=PDF, Cancel=Excel"
  }
};

/* supported languages for dropdown */
const supportedLangs = [
  {code:'zh-TW', label:'TW ç¹é«”ä¸­æ–‡'},
  {code:'en-US', label:'US English è‹±æ–‡'},
  {code:'fr-FR', label:'FR æ³•æ–‡'},
  {code:'vi-VN', label:'VI è¶Šå—æ–‡'},
  {code:'th-TH', label:'TH æ³°æ–‡'},
  {code:'id-ID', label:'ID å°å°¼æ–‡'},
  {code:'ja-JP', label:'JP æ—¥æ–‡'},
  {code:'ko-KR', label:'KR éŸ“æ–‡'}
];

/* app state */
const state = {
  lang: 'zh-TW',
  pharmacists: [],
  meds: [],
  sigDataUrl: null
};

/* dom refs */
const $ = (s, root=document) => root.querySelector(s);
const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

function cacheAndInit() {
  // elements
  state.$langSel = $('#langSel');
  state.$teachLang = $('#teachLang');
  state.$eduNumber = $('#eduNumber');
  state.$mrn = $('#mrn');
  state.$patientName = $('#patientName');
  state.$contactPhone = $('#contactPhone');
  state.$proxyRelation = $('#proxyRelation');
  state.$pharmacistSelect = $('#pharmacistSelect');
  state.$eduDate = $('#eduDate');
  state.$medListWrap = $('#medListWrap');
  state.$cognitionArea = $('#cognitionArea');
  state.$satisfactionArea = $('#satisfactionArea');
  state.$sigCanvas = $('#sigCanvas');
  state.$clearSigBtn = $('#clearSigBtn');
  state.$brushSize = $('#brushSize');
  state.$sigPreview = $('#sigPreview');
  state.$saveDraftBtn = $('#saveDraftBtn');
  state.$openDraftBtn = $('#openDraftBtn');
  state.$openDraftFile = $('#openDraftFile');
  state.$resetBtn = $('#resetBtn');
  state.$exportBtn = $('#exportBtn');
  state.$managePharmacistsBtn = $('#managePharmacistsBtn');
  state.$manageMedsBtn = $('#manageMedsBtn');
  state.$modalBackdrop = $('#modalBackdrop');
  state.$modalContent = $('#modalContent');

  populateLangs();
  loadPharmacistsFromStorage();
  loadMedsFromStorage();
  applyLocale();
  initSignature();
  bindEvents();

  // default date
  state.$eduDate.value = new Date().toISOString().slice(0,10);
}

/* populate language dropdowns */
function populateLangs(){
  state.$langSel.innerHTML = '';
  state.$teachLang.innerHTML = '';
  for(const s of supportedLangs){
    const o = document.createElement('option'); o.value = s.code; o.textContent = s.label;
    const o2 = o.cloneNode(true);
    state.$langSel.appendChild(o);
    state.$teachLang.appendChild(o2);
  }
  state.$langSel.value = state.lang;
  state.$teachLang.value = state.lang;
}

/* apply locale strings to UI */
function applyLocale(){
  const L = localeStrings[state.lang] || localeStrings['zh-TW'];
  document.getElementById('langLabel').textContent = L.langLabel;
  document.getElementById('mainTitle').textContent = L.mainTitle;
  document.getElementById('greeting').textContent = L.greeting;
  state.$teachLang.value = state.lang;

  // render cognition & satisfaction
  renderQuestions();
}

/* render questions */
function renderQuestions(){
  const L = localeStrings[state.lang] || localeStrings['zh-TW'];
  // cognition
  state.$cognitionArea.innerHTML = '';
  L.cognitionQs.forEach((q, idx)=>{
    const box = document.createElement('div'); box.className='question';
    const left = document.createElement('div'); left.style.width='36px'; left.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 0 0-10 10h4l-2 3h8l-2-3h4a10 10 0 0 0-10-10z"></path></svg>`;
    const body = document.createElement('div'); body.style.flex='1';
    const title = document.createElement('div'); title.className='q-title'; title.textContent = q;
    const preLabel = document.createElement('div'); preLabel.className='tag-pre'; preLabel.textContent = L.pre;
    const postLabel = document.createElement('div'); postLabel.className='tag-post'; postLabel.textContent = L.post;
    const preRadios = createRadioRow(`cog_${idx}_pre`, L.cognitionOptions);
    const postRadios = createRadioRow(`cog_${idx}_post`, L.cognitionOptions);

    body.appendChild(title);
    const preRow = document.createElement('div'); preRow.style.marginTop='6px';
    preRow.appendChild(preLabel); preRow.appendChild(preRadios);
    body.appendChild(preRow);
    const postRow = document.createElement('div'); postRow.style.marginTop='6px';
    postRow.appendChild(postLabel); postRow.appendChild(postRadios);
    body.appendChild(postRow);

    box.appendChild(left); box.appendChild(body);
    state.$cognitionArea.appendChild(box);
  });

  // satisfaction
  state.$satisfactionArea.innerHTML = '';
  L.satisfactionQs.forEach((q, idx)=>{
    const box = document.createElement('div'); box.className='question';
    const left = document.createElement('div'); left.style.width='36px'; left.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5A4.5 4.5 0 0 1 6.5 4 6.5 6.5 0 0 1 12 6.09 6.5 6.5 0 0 1 17.5 4 4.5 4.5 0 0 1 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
    const body = document.createElement('div'); body.style.flex='1';
    const title = document.createElement('div'); title.className='q-title'; title.textContent = q;

    body.appendChild(title);

    if(idx === 2){
      // Q3: single choice (æœƒ/ä¸æœƒ/å…¶ä»–)
      const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center';
      ['yes','no','other'].forEach((v,i)=>{
        const lbl = document.createElement('label'); lbl.className='radio-btn';
        const inp = document.createElement('input'); inp.type='radio'; inp.name=`sat_${idx}`; inp.value=v;
        lbl.appendChild(inp);
        lbl.appendChild(document.createTextNode( v==='yes' ? localeStrings[state.lang].yes : (v==='no'?localeStrings[state.lang].no:localeStrings[state.lang].other) ));
        row.appendChild(lbl);
      });
      const otherInput = document.createElement('input'); otherInput.type='text'; otherInput.id=`sat_${idx}_other`; otherInput.placeholder='è«‹è¼¸å…¥å…¶ä»–å¯¶è²´æ„è¦‹'; otherInput.style.display='none';
      row.appendChild(otherInput);
      // show/hide
      row.addEventListener('change', (e)=>{
        const sel = row.querySelector('input[name="sat_2"]:checked');
        if(sel && sel.value==='other') otherInput.style.display='inline-block';
        else { otherInput.style.display='none'; otherInput.value=''; }
      });
      body.appendChild(row);
    } else if(idx === 3){
      // Q4: follow-up
      const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px';
      ['agree','disagree'].forEach(v=>{
        const lbl = document.createElement('label'); lbl.className='radio-btn';
        const inp = document.createElement('input'); inp.type='radio'; inp.name=`sat_${idx}`; inp.value=v;
        lbl.appendChild(inp);
        lbl.appendChild(document.createTextNode(v==='agree'?localeStrings[state.lang].agreeFollowUp:localeStrings[state.lang].disagreeFollowUp));
        row.appendChild(lbl);
      });
      body.appendChild(row);
      // followUp div
      const followDiv = document.createElement('div'); followDiv.id='followUpDiv'; followDiv.style.display='none'; followDiv.style.marginTop='8px';
      followDiv.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label class="field">${localeStrings[state.lang].followUpTime}</label>
            <select id="followTime"><option value="">--</option><option value="morning">${localeStrings[state.lang].morning}</option><option value="afternoon">${localeStrings[state.lang].afternoon}</option><option value="other">${localeStrings[state.lang].otherTime}</option></select>
            <input id="followTimeOther" type="text" placeholder="${localeStrings[state.lang].otherTime}" style="display:none;margin-top:6px">
          </div>
          <div>
            <label class="field">${localeStrings[state.lang].contactPerson}</label>
            <input id="followContact" type="text" placeholder="${localeStrings[state.lang].contactPerson}">
            <input id="followContactPhone" type="tel" placeholder="${localeStrings[state.lang].contactPerson} é›»è©±" style="margin-top:6px">
          </div>
        </div>
      `;
      body.appendChild(followDiv);
      // toggle
      body.addEventListener('change', (e)=>{
        const sel = body.querySelector('input[name="sat_3"]:checked');
        if(sel && sel.value==='agree') followDiv.style.display='block';
        else { followDiv.style.display='none'; $$('#followTimeOther,#followContact,#followContactPhone').forEach(i=>i.value=''); }
      });
      body.addEventListener('change', (e)=>{
        if(e.target && e.target.id==='followTime') document.getElementById('followTimeOther').style.display = e.target.value==='other' ? 'block' : 'none';
      });
    } else {
      // normal 5-point
      const radios = createRadioRow(`sat_${idx}`, localeStrings[state.lang].satisfactionOptions);
      body.appendChild(radios);
    }

    box.appendChild(left); box.appendChild(body);
    state.$satisfactionArea.appendChild(box);
  });
}

/* helper: create radio row */
function createRadioRow(name, options){
  const wrap = document.createElement('div'); wrap.className='radios';
  options.forEach((opt,i)=>{
    const lbl = document.createElement('label'); lbl.className='radio-btn';
    const circle = document.createElement('span'); circle.className='radio-circle';
    const inp = document.createElement('input'); inp.type='radio'; inp.name = name; inp.value = opt; inp.style.display='none';
    lbl.appendChild(circle); lbl.appendChild(document.createTextNode(opt));
    lbl.addEventListener('click', (e)=>{
      // set checked state manually
      const group = document.getElementsByName(name);
      group.forEach(g=>{ if(g!==inp) { /* nothing */ }});
      inp.checked = true;
      // update visuals
      wrap.querySelectorAll('.radio-circle').forEach((c,idx)=>{ c.classList.toggle('checked', idx===Array.from(wrap.children).indexOf(lbl)); });
    });
    wrap.appendChild(lbl);
    // Also update on native input change (for keyboard)
    inp.addEventListener('change', ()=> {
      wrap.querySelectorAll('.radio-circle').forEach((c,idx)=>{ c.classList.toggle('checked', idx===Array.from(wrap.children).indexOf(lbl)); });
    });
    // append hidden input for form behavior
    lbl.appendChild(inp);
  });
  return wrap;
}

/* pharmacists & meds CRUD (modal) */
function loadPharmacistsFromStorage(){
  try{ state.pharmacists = JSON.parse(localStorage.getItem('medSurvey_pharmacists')||'[]'); }catch(e){ state.pharmacists = []; }
  if(!state.pharmacists.length){
    state.pharmacists = [{id:'p1',name:'é™³è—¥å¸«'},{id:'p2',name:'æ—è—¥å¸«'}];
    localStorage.setItem('medSurvey_pharmacists', JSON.stringify(state.pharmacists));
  }
  renderPharmacistSelect();
}
function renderPharmacistSelect(){
  state.$pharmacistSelect.innerHTML = '<option value="">-- é¸æ“‡è—¥å¸« --</option>';
  state.pharmacists.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; state.$pharmacistSelect.appendChild(o); });
}
function openPharmacistManager(){
  const html = `
    <h3>è—¥å¸«åå–®ç®¡ç†</h3>
    <div style="display:flex;gap:8px;margin:8px 0;">
      <input id="newPharmName" type="text" placeholder="è¼¸å…¥è—¥å¸«å§“å" style="flex:1">
      <button id="addPharmBtn" class="btn btn-primary">æ–°å¢</button>
    </div>
    <div class="list" id="pharmList" style="margin-top:8px"></div>
    <div style="text-align:right;margin-top:8px"><button id="closeModal" class="btn btn-outline">é—œé–‰</button></div>
  `;
  showModal(html);
  const list = document.getElementById('pharmList');
  function renderList(){
    list.innerHTML = '';
    state.pharmacists.forEach((p, idx)=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0';
      row.innerHTML = `<div>${p.name}</div><div style="display:flex;gap:6px"><button data-id="${p.id}" class="btn btn-outline edit-pharm">ç·¨è¼¯</button><button data-id="${p.id}" class="btn btn-reset delete-pharm">åˆªé™¤</button></div>`;
      list.appendChild(row);
    });
  }
  renderList();
  $('#addPharmBtn').addEventListener('click', ()=>{
    const v = $('#newPharmName').value.trim(); if(!v) return alert('å§“åä¸å¯ç©ºç™½');
    const id = 'p'+Date.now(); state.pharmacists.push({id,name:v=v}); localStorage.setItem('medSurvey_pharmacists', JSON.stringify(state.pharmacists));
    $('#newPharmName').value=''; renderList(); renderPharmacistSelect();
  });
  list.addEventListener('click', (e)=>{
    if(e.target.classList.contains('edit-pharm')){
      const id = e.target.dataset.id; const p = state.pharmacists.find(x=>x.id===id);
      const nv = prompt('ç·¨è¼¯è—¥å¸«å§“å', p.name);
      if(nv){ p.name = nv; localStorage.setItem('medSurvey_pharmacists', JSON.stringify(state.pharmacists)); renderList(); renderPharmacistSelect(); }
    } else if(e.target.classList.contains('delete-pharm')){
      const id = e.target.dataset.id; if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { state.pharmacists = state.pharmacists.filter(x=>x.id!==id); localStorage.setItem('medSurvey_pharmacists', JSON.stringify(state.pharmacists)); renderList(); renderPharmacistSelect(); }
    }
  });
  $('#closeModal').addEventListener('click', hideModal);
}

function loadMedsFromStorage(){
  try{ state.meds = JSON.parse(localStorage.getItem('medSurvey_meds')||'[]'); }catch(e){ state.meds = []; }
  if(!state.meds.length){
    state.meds = [{id:'m1',name:'è—¥å“A'},{id:'m2',name:'è—¥å“B'}]; localStorage.setItem('medSurvey_meds', JSON.stringify(state.meds));
  }
  renderMedsList();
}
function renderMedsList(){
  state.$medListWrap.innerHTML = '';
  const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.gap='8px';
  state.meds.forEach(m=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px'; row.style.border='1px dashed rgba(0,0,0,0.06)';
    const left = document.createElement('label'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.name='meds'; cb.value=m.id; cb.style.width='18px'; cb.style.height='18px';
    left.appendChild(cb); left.appendChild(document.createTextNode(m.name));
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
    const edit = document.createElement('button'); edit.className='btn btn-outline'; edit.textContent='ç·¨è¼¯'; edit.dataset.id=m.id;
    const del = document.createElement('button'); del.className='btn btn-reset'; del.textContent='åˆªé™¤'; del.dataset.id=m.id;
    right.appendChild(edit); right.appendChild(del);
    row.appendChild(left); row.appendChild(right); wrap.appendChild(row);
  });
  state.$medListWrap.appendChild(wrap);
  // bind edit/delete
  wrap.addEventListener('click', (e)=>{
    if(e.target.tagName==='BUTTON'){
      const id = e.target.dataset.id; if(e.target.textContent==='ç·¨è¼¯'){
        const p = state.meds.find(x=>x.id===id); const nv = prompt('ç·¨è¼¯è—¥å“åç¨±', p.name); if(nv){ p.name = nv; localStorage.setItem('medSurvey_meds', JSON.stringify(state.meds)); renderMedsList(); }
      } else {
        if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { state.meds = state.meds.filter(x=>x.id!==id); localStorage.setItem('medSurvey_meds', JSON.stringify(state.meds)); renderMedsList(); }
      }
    }
  });
}
function openMedManager(){
  const html = `
    <h3>è—¥å“æ¸…å–®ç®¡ç†</h3>
    <div style="display:flex;gap:8px;margin:8px 0;">
      <input id="newMedName" type="text" placeholder="è¼¸å…¥è—¥å“åç¨±" style="flex:1">
      <button id="addMedBtn" class="btn btn-primary">æ–°å¢</button>
    </div>
    <div class="list" id="medList" style="margin-top:8px"></div>
    <div style="text-align:right;margin-top:8px"><button id="closeModal2" class="btn btn-outline">é—œé–‰</button></div>
  `;
  showModal(html);
  const list = document.getElementById('medList');
  function render(){
    list.innerHTML=''; state.meds.forEach((m,idx)=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0';
      row.innerHTML = `<div>${m.name}</div><div style="display:flex;gap:6px"><button data-id="${m.id}" class="btn btn-outline edit-med">ç·¨è¼¯</button><button data-id="${m.id}" class="btn btn-reset delete-med">åˆªé™¤</button></div>`;
      list.appendChild(row);
    });
  }
  render();
  $('#addMedBtn').addEventListener('click', ()=>{
    const v = $('#newMedName').value.trim(); if(!v) return alert('è—¥å“åç¨±ä¸å¯ç©ºç™½');
    const id = 'm'+Date.now(); state.meds.push({id,name:v=v}); localStorage.setItem('medSurvey_meds', JSON.stringify(state.meds)); $('#newMedName').value=''; render(); renderMedsList();
  });
  list.addEventListener('click',(e)=>{
    if(e.target.classList.contains('edit-med')){ const id=e.target.dataset.id; const m = state.meds.find(x=>x.id===id); const nv = prompt('ç·¨è¼¯è—¥å“åç¨±', m.name); if(nv){ m.name=nv; localStorage.setItem('medSurvey_meds', JSON.stringify(state.meds)); render(); renderMedsList(); } }
    if(e.target.classList.contains('delete-med')){ const id=e.target.dataset.id; if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ state.meds=state.meds.filter(x=>x.id!==id); localStorage.setItem('medSurvey_meds', JSON.stringify(state.meds)); render(); renderMedsList(); } }
  });
  $('#closeModal2').addEventListener('click', hideModal);
}

/* modal helper */
function showModal(html){
  state.$modalContent.innerHTML = html;
  state.$modalBackdrop.style.display = 'flex';
}
function hideModal(){
  state.$modalBackdrop.style.display = 'none';
  state.$modalContent.innerHTML = '';
}

/* signature canvas */
let sigCtx, drawing=false, lastPos={x:0,y:0};
function initSignature(){
  const canvas = state.$sigCanvas;
  const ctx = canvas.getContext('2d');
  sigCtx = ctx;
  function resize(){
    const ratio = window.devicePixelRatio || 1;
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    canvas.width = Math.floor(w * ratio * 2);
    canvas.height = Math.floor(h * ratio * 2);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.scale(ratio*2, ratio*2);
    ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(state.sigDataUrl){ const img = new Image(); img.onload = ()=> ctx.drawImage(img,0,0, canvas.clientWidth, canvas.clientHeight); img.src = state.sigDataUrl; }
  }
  resize(); window.addEventListener('resize', resize);

  function getPtr(e){
    const r = canvas.getBoundingClientRect();
    if(e.touches && e.touches[0]) return {x:e.touches[0].clientX - r.left, y:e.touches[0].clientY - r.top};
    return {x: e.clientX - r.left, y: e.clientY - r.top};
  }
  canvas.addEventListener('pointerdown', (e)=>{ drawing=true; lastPos = getPtr(e); });
  canvas.addEventListener('pointermove', (e)=>{ if(!drawing) return; const p = getPtr(e); ctx.beginPath(); ctx.moveTo(lastPos.x, lastPos.y); ctx.lineTo(p.x,p.y); ctx.lineWidth = state.$brushSize.value * 1.2; ctx.strokeStyle = '#111'; ctx.stroke(); lastPos = p; });
  window.addEventListener('pointerup', ()=>{ if(drawing){ drawing=false; saveSig(); } });
  state.$clearSigBtn.addEventListener('click', ()=>{ ctx.clearRect(0,0, canvas.width, canvas.height); state.sigDataUrl = null; state.$sigPreview.textContent='å°šæœªç°½å'; });
  state.$brushSize.addEventListener('input', ()=>{ ctx.lineWidth = state.$brushSize.value; });
}

function saveSig(){
  // export as base64 PNG (2x ratio already set)
  try{
    const data = state.$sigCanvas.toDataURL('image/png');
    state.sigDataUrl = data;
    state.$sigPreview.textContent = 'å·²ç°½å';
  }catch(e){ console.error(e); }
}

/* collect form data */
function collectFormData(){
  const data = {
    meta:{lang:state.lang, savedAt:(new Date()).toISOString()},
    patient:{
      filledBy: document.querySelector('input[name="filledBy"]:checked')?.value || '',
      proxyRelation: state.$proxyRelation.value || '',
      mrn: sanitizeMrn(state.$mrn.value || ''),
      name: state.$patientName.value || '',
      phone: sanitizePhone(state.$contactPhone.value || ''),
      education: state.$education?.value || '',
      teachLang: state.$teachLang.value || ''
    },
    pharmacist:{
      id: state.$pharmacistSelect.value || '',
      name: (state.pharmacists.find(p=>p.id===state.$pharmacistSelect.value) || {}).name || '',
      eduDate: state.$eduDate.value || ''
    },
    meds: $$('input[name="meds"]:checked').map(i=>i.value),
    cognition: {},
    satisfaction: {},
    signature: state.sigDataUrl || null
  };
  // cognition radios
  $$('input[type="radio"]').forEach(r=>{
    if(r.name && r.checked) {
      if(r.name.startsWith('cog_')) data.cognition[r.name] = r.value;
      if(r.name.startsWith('sat_')) data.satisfaction[r.name] = r.value;
    }
  });
  // sat_2 other
  const sat2 = $('#sat_2_other'); if(sat2) data.satisfaction['sat_2_other'] = sat2.value || '';
  // follow-up
  const ft = $('#followTime'); if(ft) data.satisfaction['followTime'] = ft.value || '';
  const fto = $('#followTimeOther'); if(fto) data.satisfaction['followTimeOther'] = fto.value || '';
  const fc = $('#followContact'); if(fc) data.satisfaction['followContact'] = fc.value || '';
  const fcp = $('#followContactPhone'); if(fcp) data.satisfaction['followContactPhone'] = fcp.value || '';
  return data;
}

/* save draft to localStorage and download JSON */
function saveDraft(){
  const data = collectFormData();
  const eduNo = data.patient.mrn || 'NOID';
  const key = `medSurveyDraft_${eduNo}_${Date.now()}`;
  localStorage.setItem(key, JSON.stringify(data));
  const fname = `survey_draft_${eduNo}_${(new Date()).toISOString().slice(0,10)}.json`;
  downloadFile(fname, JSON.stringify(data, null, 2), 'application/json');
  // show missing markers for required fields but still allow save
  validateMinimalForSave();
  alert('è‰ç¨¿å·²å„²å­˜ï¼ˆlocalStorage èˆ‡ JSON ä¸‹è¼‰ï¼‰');
}

/* list drafts in localStorage */
function listLocalDrafts(){
  const keys = Object.keys(localStorage).filter(k=>k.startsWith('medSurveyDraft_'));
  if(!keys.length) return alert('localStorage ç„¡è‰ç¨¿');
  const list = keys.map((k,i)=>`${i+1}. ${k}`).join('\n');
  const sel = parseInt(prompt('é¸æ“‡è‰ç¨¿ç·¨è™Ÿï¼ˆæ•¸å­—ï¼‰è¼‰å…¥ï¼š\n'+list)) - 1;
  if(isNaN(sel) || !keys[sel]) return;
  const data = JSON.parse(localStorage.getItem(keys[sel]));
  applyDraftToForm(data);
  alert('å·²å¾ localStorage è¼‰å…¥è‰ç¨¿');
}

/* open draft from file */
function openDraftFromFile(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=> {
    try{
      const obj = JSON.parse(e.target.result);
      applyDraftToForm(obj);
      alert('å·²æˆåŠŸè¼‰å…¥ä¸Šå‚³çš„è‰ç¨¿ JSON');
    }catch(err){ alert('è®€å–å¤±æ•—ï¼šéæ­£ç¢ºæ ¼å¼ JSON'); }
  };
  reader.readAsText(file);
}

/* apply draft to form */
function applyDraftToForm(data){
  if(!data) return;
  state.lang = data.meta?.lang || state.lang;
  state.$langSel.value = state.lang;
  applyLocale();

  state.$mrn.value = data.patient?.mrn || '';
  $('#eduNumber').textContent = state.$mrn.value || '______';
  state.$patientName.value = data.patient?.name || '';
  state.$contactPhone.value = data.patient?.phone || '';
  state.$education.value = data.patient?.education || '';
  state.$teachLang.value = data.patient?.teachLang || state.lang;
  if(data.pharmacist?.id) state.$pharmacistSelect.value = data.pharmacist.id;
  state.$eduDate.value = data.pharmacist?.eduDate || '';
  // meds
  $$('input[name="meds"]').forEach(cb=> cb.checked = (data.meds||[]).includes(cb.value));
  // cognition & satisfaction
  for(const [k,v] of Object.entries(data.cognition || {})){
    const r = document.querySelector(`input[name="${k}"][value="${v}"]`);
    if(r) r.checked = true;
  }
  for(const [k,v] of Object.entries(data.satisfaction || {})){
    const r = document.querySelector(`input[name="${k}"][value="${v}"]`);
    if(r) r.checked = true;
  }
  if(data.satisfaction?.sat_2_other) $('#sat_2_other').value = data.satisfaction.sat_2_other || '';
  if(data.signature){
    state.sigDataUrl = data.signature;
    const img = new Image();
    img.onload = ()=> { sigCtx.clearRect(0,0, state.$sigCanvas.width, state.$sigCanvas.height); sigCtx.drawImage(img,0,0, state.$sigCanvas.clientWidth, state.$sigCanvas.clientHeight); state.$sigPreview.textContent='å·²ç°½å'; };
    img.src = data.signature;
  }
}

/* validation helpers */
function sanitizeMrn(v){ return (v||'').toUpperCase().replace(/[^A-Z0-9]/g,''); }
function sanitizePhone(v){ return (v||'').replace(/[^\d+]/g,''); }
function markInvalid(el, msg){
  const err = el.closest('.card')?.querySelector('.error') || el.closest('div')?.querySelector('.error');
  if(err){ err.textContent = msg || localeStrings[state.lang].required; err.style.display='block'; }
  el.focus(); scrollToElement(el);
}
function clearErrors(){
  $$('.error').forEach(e=>e.style.display='none');
}
function scrollToElement(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); }

/* minimal validation when saving draft (show required markers) */
function validateMinimalForSave(){
  clearErrors();
  if(!sanitizeMrn(state.$mrn.value)) markInvalid(state.$mrn, localeStrings[state.lang].required);
  if(!state.$patientName.value.trim()) markInvalid(state.$patientName, localeStrings[state.lang].required);
  if(!state.sigDataUrl) markInvalid(state.$sigCanvas, localeStrings[state.lang].required);
  // phone format
  const phone = sanitizePhone(state.$contactPhone.value);
  if(!phone || phone.replace(/[^\d]/g,'').length < 6) markInvalid(state.$contactPhone, 'æ ¼å¼éŒ¯èª¤ï¼ˆæœ€å°‘ 6 ç¢¼ï¼‰');
}

/* full validation before completing */
function validateBeforeComplete(){
  clearErrors();
  // patient basic
  const mrn = sanitizeMrn(state.$mrn.value);
  if(!mrn){ markInvalid(state.$mrn, localeStrings[state.lang].required); return false; }
  if(!state.$patientName.value.trim()){ markInvalid(state.$patientName, localeStrings[state.lang].required); return false; }
  const phone = sanitizePhone(state.$contactPhone.value);
  if(!phone || phone.replace(/[^\d]/g,'').length < 6){ markInvalid(state.$contactPhone, 'æ ¼å¼éŒ¯èª¤ï¼ˆæœ€å°‘ 6 ç¢¼ï¼‰'); return false; }
  // pharmacist
  if(!state.$pharmacistSelect.value){ markInvalid(state.$pharmacistSelect, localeStrings[state.lang].required); return false; }
  // signature
  if(!state.sigDataUrl){ markInvalid(state.$sigCanvas, localeStrings[state.lang].required); return false; }
  // cognition: each of 3 questions must have pre & post
  for(let i=0;i<3;i++){
    if(!document.querySelector(`input[name="cog_${i}_pre"]:checked`) || !document.querySelector(`input[name="cog_${i}_post"]:checked`)){
      const qel = state.$cognitionArea.children[i];
      markInvalid(qel, localeStrings[state.lang].required);
      return false;
    }
  }
  // satisfaction: each of 4 must have selection
  for(let i=0;i<4;i++){
    if(!document.querySelector(`input[name="sat_${i}"]:checked`)){
      const qel = state.$satisfactionArea.children[i];
      markInvalid(qel, localeStrings[state.lang].required);
      return false;
    }
    // if q3 other selected, ensure other text present
    if(i===2){
      const sel = document.querySelector('input[name="sat_2"]:checked');
      if(sel && sel.value==='other'){
        if(!$('#sat_2_other').value.trim()){ markInvalid($('#sat_2_other'), 'è«‹å¡«å¯«å…¶ä»–æ„è¦‹'); return false; }
      }
    }
    // if q4 agree, ensure follow-up fields
    if(i===3){
      const sel = document.querySelector('input[name="sat_3"]:checked');
      if(sel && sel.value==='agree'){
        if(!$('#followContactPhone').value.trim() || !$('#followContact').value.trim()){
          markInvalid($('#followContactPhone'), 'è«‹å¡«å¯«è¯çµ¡äººèˆ‡è¯çµ¡é›»è©±'); return false;
        }
      }
    }
  }
  return true;
}

/* export: Excel via SheetJS */
async function exportToExcel(data){
  if(!window.XLSX){ alert('SheetJS æœªè¼‰å…¥ï¼Œå°‡ä¸‹è¼‰ JSON ä½œç‚ºæ›¿ä»£'); downloadFile('survey.json', JSON.stringify(data, null,2)); return; }
  const aoa = [];
  aoa.push(['è¡›æ•™ç·¨è™Ÿ', data.patient.mrn || '']);
  aoa.push(['å§“å', data.patient.name || '']);
  aoa.push(['è¯çµ¡é›»è©±', data.patient.phone || '']);
  aoa.push(['è¡›æ•™è—¥å¸«', data.pharmacist.name || '']);
  aoa.push(['è¡›æ•™æ—¥æœŸ', data.pharmacist.eduDate || '']);
  aoa.push([]);
  aoa.push(['è—¥å“', (data.meds || []).map(id => (state.meds.find(m=>m.id===id) || {}).name || id).join('; ')]);
  aoa.push([]);
  aoa.push(['èªçŸ¥åº¦ (å‰ / å¾Œ)']);
  for(let i=0;i<3;i++){
    aoa.push([`Q${i+1}`, data.cognition[`cog_${i}_pre`] || '', data.cognition[`cog_${i}_post`] || '']);
  }
  aoa.push([]);
  aoa.push(['æ»¿æ„åº¦']);
  for(let i=0;i<4;i++){
    const v = data.satisfaction[`sat_${i}`] || '';
    let extra = '';
    if(i===2) extra = data.satisfaction['sat_2_other'] || '';
    if(i===3) extra = `followTime:${data.satisfaction.followTime||''}; contact:${data.satisfaction.followContact||''}; phone:${data.satisfaction.followContactPhone||''}`;
    aoa.push([`Q${i+1}`, v, extra]);
  }
  aoa.push([]);
  aoa.push(['ç°½å(Base64)']);
  aoa.push([data.signature || '']);

  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Survey');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const fname = `survey_${data.patient.mrn || 'NOID'}_${(new Date()).toISOString().slice(0,10)}.xlsx`;
  downloadFile(fname, wbout, 'application/octet-stream');
}

/* export: PDF via html2canvas + jsPDF (single page or scaled) */
async function exportToPDF(data){
  if(!window.html2canvas || !window.jspdf){ alert('PDF å¥—ä»¶æœªè¼‰å…¥ï¼Œå°‡ä¸‹è¼‰ JSON ä½œæ›¿ä»£'); downloadFile('survey.json', JSON.stringify(data, null,2)); return; }

  // build printable DOM fragment
  const wrapper = document.createElement('div');
  wrapper.style.width = '794px';
  wrapper.style.padding = '12px';
  wrapper.style.background = '#fff';
  wrapper.style.color = '#123';
  wrapper.innerHTML = `
    <h2 style="text-align:center;color:${getComputedStyle(document.documentElement).getPropertyValue('--primary-blue')}">${localeStrings[state.lang].mainTitle || ''}</h2>
    <div style="text-align:right">è¡›æ•™ç·¨è™Ÿï¼š ${data.patient.mrn || ''}</div>
    <hr/>
    <div>
      <div><strong>å§“å:</strong> ${data.patient.name||''}</div>
      <div><strong>è¯çµ¡é›»è©±:</strong> ${data.patient.phone||''}</div>
      <div><strong>è¡›æ•™è—¥å¸«:</strong> ${data.pharmacist.name||''}</div>
      <div><strong>è¡›æ•™æ—¥æœŸ:</strong> ${data.pharmacist.eduDate||''}</div>
    </div>
    <hr/>
    <div><strong>è¡›æ•™è—¥å“:</strong> ${(data.meds||[]).map(id=> (state.meds.find(m=>m.id===id)||{}).name || id).join(', ')}</div>
    <hr/>
    <div><strong>èªçŸ¥åº¦</strong></div>
  `;
  // cognition table
  const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse'; table.style.fontSize='12px';
  const tbody = document.createElement('tbody');
  for(let i=0;i<3;i++){
    const tr = document.createElement('tr');
    const tdQ = document.createElement('td'); tdQ.style.border='1px solid #ddd'; tdQ.style.padding='6px'; tdQ.innerHTML = `<strong>${i+1}.</strong> ${localeStrings[state.lang].cognitionQs[i] || ''}`;
    const tdPre = document.createElement('td'); tdPre.style.border='1px solid #ddd'; tdPre.style.padding='6px'; tdPre.textContent = data.cognition[`cog_${i}_pre`] || '';
    const tdPost = document.createElement('td'); tdPost.style.border='1px solid #ddd'; tdPost.style.padding='6px'; tdPost.textContent = data.cognition[`cog_${i}_post`] || '';
    tr.appendChild(tdQ); tr.appendChild(tdPre); tr.appendChild(tdPost); tbody.appendChild(tr);
  }
  table.appendChild(tbody); wrapper.appendChild(table);

  // satisfaction
  const satDiv = document.createElement('div'); satDiv.style.marginTop='12px';
  satDiv.innerHTML = '<strong>æ»¿æ„åº¦</strong>';
  const satTbl = document.createElement('table'); satTbl.style.width='100%'; satTbl.style.borderCollapse='collapse'; satTbl.style.fontSize='12px';
  const satBody = document.createElement('tbody');
  for(let i=0;i<4;i++){
    const tr = document.createElement('tr');
    const tdQ = document.createElement('td'); tdQ.style.border='1px solid #ddd'; tdQ.style.padding='6px'; tdQ.innerHTML = `<strong>${i+1}.</strong> ${localeStrings[state.lang].satisfactionQs[i] || ''}`;
    const tdV = document.createElement('td'); tdV.style.border='1px solid #ddd'; tdV.style.padding='6px'; tdV.textContent = data.satisfaction[`sat_${i}`] || '';
    tr.appendChild(tdQ); tr.appendChild(tdV); satBody.appendChild(tr);
  }
  satTbl.appendChild(satBody); satDiv.appendChild(satTbl); wrapper.appendChild(satDiv);

  // signature
  const sigDiv = document.createElement('div'); sigDiv.style.marginTop='12px';
  sigDiv.innerHTML = `<strong>ç°½åï¼š</strong><div style="border:1px solid #ddd;padding:6px;margin-top:6px"></div>`;
  if(data.signature){
    const img = new Image(); img.src = data.signature; img.style.maxWidth='100%';
    sigDiv.querySelector('div').appendChild(img);
  } else sigDiv.querySelector('div').textContent = 'ç„¡ç°½å';
  wrapper.appendChild(sigDiv);

  // render to canvas -> pdf
  document.body.appendChild(wrapper);
  try{
    const canvas = await html2canvas(wrapper, {scale:2, useCORS:false, backgroundColor:'#fff'});
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF({unit:'pt', format:'a4', orientation:'portrait'});
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    // fit image to page width with margin
    const margin = 20;
    const imgProps = {width: canvas.width, height: canvas.height};
    const ratio = Math.min((pageWidth - 2*margin) / imgProps.width, (pageHeight - 2*margin) / imgProps.height);
    const drawW = imgProps.width * ratio;
    const drawH = imgProps.height * ratio;
    pdf.addImage(imgData, 'PNG', margin, margin, drawW, drawH);
    const fname = `survey_${data.patient.mrn || 'NOID'}_${(new Date()).toISOString().slice(0,10)}.pdf`;
    pdf.save(fname);
  }catch(e){ console.error(e); alert('PDF ç”¢ç”Ÿå¤±æ•—ï¼Œå°‡ä¸‹è¼‰ JSON ä½œç‚ºæ›¿ä»£'); downloadFile('survey.json', JSON.stringify(data, null,2)); }
  wrapper.remove();
}

/* utility: download file */
function downloadFile(filename, content, mime='application/json'){
  const blob = content instanceof ArrayBuffer ? new Blob([content], {type:mime}) : new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 5000);
}

/* bind events */
function bindEvents(){
  // language
  state.$langSel.addEventListener('change', (e)=>{ state.lang = e.target.value; applyLocale(); });
  // mrn sync
  state.$mrn.addEventListener('input', (e)=>{ const v = sanitizeMrn(e.target.value); state.$mrn.value = v; state.$eduNumber.textContent = v || '______'; });
  // filledBy
  $$('input[name="filledBy"]').forEach(r=> r.addEventListener('change', (e)=> { if(e.target.value==='proxy') state.$proxyRelation.style.display='inline-block'; else state.$proxyRelation.style.display='none'; }));
  // open draft
  state.$openDraftBtn.addEventListener('click', ()=> {
    const choice = confirm('å¾ localStorage è®€å–è‰ç¨¿ï¼ŸæŒ‰ã€Œå–æ¶ˆã€å¯ä¸Šå‚³ JSON æª”æ¡ˆ');
    if(choice) listLocalDrafts();
    else state.$openDraftFile.click();
  });
  state.$openDraftFile.addEventListener('change', (e)=> openDraftFromFile(e.target.files[0]));
  // save draft
  state.$saveDraftBtn.addEventListener('click', ()=> saveDraft());
  // reset
  state.$resetBtn.addEventListener('click', ()=>{
    if(confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰æ¬„ä½ï¼Ÿï¼ˆå¯é¸æ˜¯å¦æ¸…é™¤æ‰€æœ‰è‰ç¨¿ï¼‰')){
      // clear inputs
      $$('input,textarea,select').forEach(i=>{
        if(i.type==='radio' || i.type==='checkbox') i.checked = false;
        else i.value = '';
      });
      state.sigDataUrl = null; sigCtx.clearRect(0,0, state.$sigCanvas.width, state.$sigCanvas.height); state.$sigPreview.textContent='å°šæœªç°½å';
      if(confirm('æ˜¯å¦åŒæ™‚åˆªé™¤ localStorage çš„æ‰€æœ‰è‰ç¨¿ (medSurveyDraft_*)ï¼Ÿ')) {
        Object.keys(localStorage).filter(k=>k.startsWith('medSurveyDraft_')).forEach(k=>localStorage.removeItem(k));
      }
      alert('è¡¨å–®å·²é‡ç½®');
    }
  });
  // export/complete
  state.$exportBtn.addEventListener('click', async ()=>{
    const ok = validateBeforeComplete();
    if(!ok) return alert('è¡¨å–®å°šæœ‰æœªå®Œæˆé …ç›®ï¼Œè«‹æª¢æŸ¥ä¸¦è£œé½Š');
    const data = collectFormData();
    const choice = confirm(localeStrings[state.lang].exportChoose || 'Export? OK=PDF, Cancel=Excel');
    if(choice) await exportToPDF(data);
    else await exportToExcel(data);
  });

  // pharmacist / med management
  state.$managePharmacistsBtn.addEventListener('click', openPharmacistManager);
  state.$manageMedsBtn.addEventListener('click', openMedManager);

  // modal backdrop close via click outside
  state.$modalBackdrop.addEventListener('click', (e)=> { if(e.target === state.$modalBackdrop) hideModal(); });

  // med checkbox rendering: ensure medList exists initially
  renderMedsList();
}

/* initialization */
document.addEventListener('DOMContentLoaded', ()=>{ cacheAndInit(); bindEvents(); });

</script>
</body>
</html>
