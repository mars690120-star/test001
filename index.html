<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>義大癌治療醫院門診用藥指導服務滿意度問卷</title>
    
    <!-- 引入必要的外部函式庫 (CDN) -->
    <!-- PDF 生成 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Excel 生成 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            /* 主色系定義 */
            --medical-blue: #0056b3; /* 醫療藍 */
            --tech-green: #28a745;   /* 科技綠 */
            --tech-gray: #6c757d;    /* 科技灰 */
            --bg-color: #f8f9fa;
            --text-color: #333;
            --border-color: #ced4da;
            --error-color: #dc3545;
            --pre-color: #d63384;    /* 衛教前顏色 */
            --post-color: #0d6efd;   /* 衛教後顏色 */
        }

        * {
            box-sizing: border-box;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        /* 響應式容器，模擬 A4 寬度體驗但支援手機 */
        .container {
            max-width: 210mm; /* A4 width approx */
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        /* ----- 語言切換 ----- */
        .lang-selector {
            position: absolute;
            top: 10px;
            left: 40px;
            z-index: 100;
        }
        select.lang-select {
            padding: 5px 10px;
            border: 1px solid var(--medical-blue);
            color: var(--medical-blue);
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ----- 標題區域 ----- */
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            padding-top: 20px;
        }

        .header-top-right {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 4px;
            background: #fff;
        }

        h1 {
            color: var(--medical-blue);
            font-size: 1.8rem;
            margin: 10px 0;
            line-height: 1.4;
        }

        .greeting {
            font-size: 0.95rem;
            color: #555;
            text-align: justify;
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f7ff;
            border-left: 4px solid var(--medical-blue);
        }

        /* ----- 通用欄位樣式 ----- */
        .section-title {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            color: var(--medical-blue);
            border-bottom: 2px solid var(--medical-blue);
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .section-title svg {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            fill: var(--tech-green);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #444;
        }

        /* 透明輸入框設計 */
        input[type="text"], 
        input[type="tel"], 
        input[type="number"], 
        input[type="date"],
        select {
            background-color: transparent;
            border: 1px solid transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 8px 5px;
            font-size: 1rem;
            width: 100%;
            outline: none;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            border-bottom: 2px solid var(--tech-green);
        }

        /* 必填標示 */
        .required::after {
            content: " *";
            color: var(--error-color);
        }

        /* 錯誤訊息 */
        .error-msg {
            color: var(--error-color);
            font-size: 0.8rem;
            display: none;
            margin-top: 4px;
        }
        .has-error input, .has-error select {
            border-bottom-color: var(--error-color);
        }
        .has-error .error-msg {
            display: block;
        }

        /* ----- 自定義 Radio 按鈕 ----- */
        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            min-height: 40px;
        }
        
        .radio-option {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .radio-option input {
            display: none;
        }

        .radio-circle {
            width: 18px;
            height: 18px;
            border: 2px solid var(--medical-blue);
            border-radius: 50%;
            margin-right: 8px;
            position: relative;
            transition: all 0.3s;
        }

        .radio-option input:checked + .radio-circle {
            background: linear-gradient(45deg, var(--medical-blue), var(--tech-green));
            border-color: transparent;
        }

        .radio-option input:checked + .radio-circle::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 8px;
            height: 4px;
            border-left: 2px solid white;
            border-bottom: 2px solid white;
            transform: rotate(-45deg);
        }

        /* ----- 衛教藥師與藥品維護區域 ----- */
        .manage-controls {
            font-size: 0.8rem;
            margin-left: 10px;
        }
        .btn-mini {
            background: #eee;
            border: none;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            color: #555;
        }
        .btn-mini:hover { background: #ddd; }

        .medicine-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        /* ----- 問卷區塊 ----- */
        .question-block {
            margin-bottom: 25px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .q-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .q-icon {
            margin-right: 8px;
            width: 20px;
            height: 20px;
            fill: var(--medical-blue);
        }

        .sub-q-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-left: 28px;
        }

        .pre-label { color: var(--pre-color); font-weight: bold; margin-right: 10px; width: 60px;}
        .post-label { color: var(--post-color); font-weight: bold; margin-right: 10px; width: 60px;}

        /* 隱藏欄位 */
        .hidden-section {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background-color: #f1f8e9; /* 淺綠背景 */
            border-radius: 5px;
        }

        /* ----- 簽名板 ----- */
        .signature-wrapper {
            border: 2px dashed var(--border-color);
            background: #fff;
            position: relative;
            height: 200px;
            width: 100%;
            border-radius: 8px;
        }
        canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        .clear-sig-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.8);
            border: 1px solid #ccc;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* ----- 聲明條款 ----- */
        .privacy-policy {
            font-size: 0.75rem;
            color: #666;
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 10px;
            line-height: 1.4;
            text-align: justify;
        }

        /* ----- 功能按鈕 ----- */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }

        .btn svg {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            fill: currentColor;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-draft { background-color: var(--tech-green); }
        .btn-load { background-color: #dc3545; }
        .btn-submit { background-color: var(--medical-blue); }
        .btn-reset { background-color: var(--tech-gray); }

        /* 列印/PDF 樣式調整 */
        @media print {
            .container {
                box-shadow: none;
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: none;
            }
            .action-buttons, .manage-controls, .lang-selector, .clear-sig-btn {
                display: none !important;
            }
            body { background: white; }
            /* 強制背景色列印 */
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }

        /* 手機版調整 */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            .form-row { flex-direction: column; gap: 10px; }
            .radio-group { gap: 10px; }
            .sub-q-row { flex-direction: column; align-items: flex-start; }
            .pre-label, .post-label { margin-bottom: 5px; }
            .header-top-right { position: static; margin-bottom: 10px; text-align: center; }
            .lang-selector { position: static; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

<!-- 註解說明與 README -->
<!-- 
    README: 維護與操作說明
    1. 藥師名單與藥品清單預設存在 JavaScript 的 defaultData 中。
    2. 使用者在介面上新增的藥師/藥品會儲存在瀏覽器的 LocalStorage，重整後保留。
    3. 「重置」功能會清空 LocalStorage 中的暫存資料。
    4. 本系統不對外傳送資料，所有 PDF/Excel 產生皆在瀏覽器端完成。
    5. 若需修改標題或聲明，請直接編輯 HTML 內的文字。
-->

<div class="container" id="surveyForm">
    
    <!-- 語言選擇 -->
    <div class="lang-selector">
        <select id="langSelect" class="lang-select" onchange="changeLanguage()">
            <option value="tw">TW 繁體中文</option>
            <option value="en">English (英文)</option>
            <option value="fr">Français (法文)</option>
            <option value="vn">Tiếng Việt (越南文)</option>
            <option value="th">ไทย (泰文)</option>
            <option value="id">Bahasa Indonesia (印尼文)</option>
            <option value="jp">日本語 (日文)</option>
            <option value="kr">한국어 (韓文)</option>
        </select>
    </div>

    <header>
        <div class="header-top-right">
            <span data-i18n="eduIdLabel">衛教編號：</span>
            <span id="eduIdDisplay" style="font-weight:bold; color:var(--medical-blue);"></span>
        </div>
        <h1 data-i18n="mainTitle">義大癌治療醫院門診用藥指導服務滿意度問卷</h1>
        <div class="greeting">
            <span data-i18n="greetingText">
                各位先生、女士：您好！<br>
                癌治療醫院藥劑科為能提升更好的服務品質與顧客滿意度，敬請您協助填寫下列資料並並提供您的寶貴意見，以供我們參考與改進。<br>
                敬祝 平安 &nbsp;&nbsp;&nbsp; 癌治療醫院藥劑科關心您
            </span>
        </div>
    </header>

    <form id="mainForm" onsubmit="return false;">
        
        <!-- 1. 基本資料 -->
        <div class="section-title">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span data-i18n="secBasic">病人基本資料</span>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="required" data-i18n="fillerLabel">填寫者</label>
                <div class="radio-group" id="fillerGroup">
                    <label class="radio-option">
                        <input type="radio" name="filler" value="self" onclick="toggleProxyInput(false)">
                        <span class="radio-circle"></span>
                        <span data-i18n="fillerSelf">病人本人</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="filler" value="proxy" onclick="toggleProxyInput(true)">
                        <span class="radio-circle"></span>
                        <span data-i18n="fillerProxy">代填</span>
                    </label>
                </div>
                <input type="text" id="proxyRelation" placeholder="關係 (Relation)" style="display:none; margin-top:5px;">
                <div class="error-msg" data-i18n="errRequired">此欄位必填</div>
            </div>
            
            <div class="form-group">
                <label class="required" data-i18n="chartNoLabel">病歷號 / 身分證號</label>
                <input type="text" id="chartNo" name="chartNo" placeholder="A-Z, 0-9" onkeyup="syncEduId(this)" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                <div class="error-msg" data-i18n="errChartNo">請輸入英數字</div>
            </div>

            <div class="form-group">
                <label class="required" data-i18n="nameLabel">姓名</label>
                <input type="text" id="patientName" name="patientName">
                <div class="error-msg" data-i18n="errRequired">此欄位必填</div>
            </div>

            <div class="form-group">
                <label class="required" data-i18n="phoneLabel">聯絡電話</label>
                <input type="tel" id="patientPhone" name="patientPhone" placeholder="0912345678" oninput="this.value = this.value.replace(/[^0-9+]/g, '')">
                <div class="error-msg" data-i18n="errPhone">格式錯誤 (至少6碼)</div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label data-i18n="eduLevelLabel">教育程度</label>
                <div class="radio-group">
                    <label class="radio-option"><input type="radio" name="eduLevel" value="primary"><span class="radio-circle"></span><span data-i18n="eduPri">小學</span></label>
                    <label class="radio-option"><input type="radio" name="eduLevel" value="junior"><span class="radio-circle"></span><span data-i18n="eduJun">國中</span></label>
                    <label class="radio-option"><input type="radio" name="eduLevel" value="senior"><span class="radio-circle"></span><span data-i18n="eduSen">高中</span></label>
                    <label class="radio-option"><input type="radio" name="eduLevel" value="college"><span class="radio-circle"></span><span data-i18n="eduCol">大(專)</span></label>
                    <label class="radio-option"><input type="radio" name="eduLevel" value="master"><span class="radio-circle"></span><span data-i18n="eduMas">碩士以上</span></label>
                    <label class="radio-option"><input type="radio" name="eduLevel" value="none"><span class="radio-circle"></span><span data-i18n="eduNone">不識字</span></label>
                </div>
            </div>
             <div class="form-group">
                <label data-i18n="eduLangLabel">衛教語言</label>
                <select id="eduLang">
                    <option value="tw">中文</option>
                    <option value="twn">台語</option>
                    <option value="en">English</option>
                    <option value="other">其他</option>
                </select>
            </div>
        </div>

        <!-- 2. 衛教藥師 -->
        <div class="section-title">
            <svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
            <span data-i18n="secPharmacist">衛教藥師資訊</span>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="required" data-i18n="pharmacistLabel">衛教藥師</label>
                <div style="display:flex; gap:5px;">
                    <select id="pharmacistSelect" style="flex:1"></select>
                    <button class="btn-mini" onclick="addPharmacist()">+</button>
                    <button class="btn-mini" onclick="removePharmacist()">-</button>
                </div>
            </div>
            <div class="form-group">
                <label class="required" data-i18n="dateLabel">衛教日期</label>
                <input type="date" id="eduDate">
            </div>
        </div>

        <!-- 3. 藥品選擇 -->
        <div class="section-title">
            <svg viewBox="0 0 24 24"><path d="M4.5 10.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm15 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm-5.77-5.07c1.68 1.14 2.77 3.06 2.77 5.07 0 2.01-1.09 3.93-2.77 5.07L12 17.5l-1.73-1.93C8.59 14.43 7.5 12.51 7.5 10.5c0-2.01 1.09-3.93 2.77-5.07L12 3.5l1.73 1.93zM21 11c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"/></svg>
            <span data-i18n="secMedicine">衛教藥品選擇</span>
            <div class="manage-controls">
                <button class="btn-mini" onclick="addMedicine()">新增藥品</button>
            </div>
        </div>
        <div class="medicine-list" id="medicineListContainer">
            <!-- 藥品清單由 JS 生成 -->
        </div>

        <!-- 4. 認知度評估 -->
        <div class="section-title">
            <svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
            <span data-i18n="secKnowledge">藥物認知評估 (知識度)</span>
        </div>
        
        <!-- Knowledge Q1 -->
        <div class="question-block" id="k_q1">
            <div class="q-title">
                <svg class="q-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                1. <span data-i18n="kQ1">您是否知道此藥物的作用？</span>
            </div>
            <div class="sub-q-row">
                <span class="pre-label" data-i18n="preEdu">衛教前</span>
                <div class="radio-group" id="k_q1_pre"></div>
            </div>
            <div class="sub-q-row">
                <span class="post-label" data-i18n="postEdu">衛教後</span>
                <div class="radio-group" id="k_q1_post"></div>
            </div>
            <div class="error-msg" data-i18n="errAnswer">請作答</div>
        </div>

        <!-- Knowledge Q2 -->
        <div class="question-block" id="k_q2">
            <div class="q-title">
                <svg class="q-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                2. <span data-i18n="kQ2">您是否會使用或操作該藥物？</span>
            </div>
            <div class="sub-q-row">
                <span class="pre-label" data-i18n="preEdu">衛教前</span>
                <div class="radio-group" id="k_q2_pre"></div>
            </div>
            <div class="sub-q-row">
                <span class="post-label" data-i18n="postEdu">衛教後</span>
                <div class="radio-group" id="k_q2_post"></div>
            </div>
             <div class="error-msg" data-i18n="errAnswer">請作答</div>
        </div>

        <!-- Knowledge Q3 -->
        <div class="question-block" id="k_q3">
            <div class="q-title">
                <svg class="q-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                3. <span data-i18n="kQ3">您是否知道該藥物使用時的注意事項？</span>
            </div>
            <div class="sub-q-row">
                <span class="pre-label" data-i18n="preEdu">衛教前</span>
                <div class="radio-group" id="k_q3_pre"></div>
            </div>
            <div class="sub-q-row">
                <span class="post-label" data-i18n="postEdu">衛教後</span>
                <div class="radio-group" id="k_q3_post"></div>
            </div>
             <div class="error-msg" data-i18n="errAnswer">請作答</div>
        </div>


        <!-- 5. 滿意度調查 -->
        <div class="section-title">
            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            <span data-i18n="secSat">滿意度調查</span>
        </div>

        <!-- Sat Q1 -->
        <div class="question-block" id="s_q1">
            <div class="q-title">1. <span data-i18n="sQ1">您對本院提供此用藥指導服務流程滿意嗎？</span></div>
            <div class="radio-group" id="s_q1_opts"></div>
            <div class="error-msg" data-i18n="errAnswer">請作答</div>
        </div>

        <!-- Sat Q2 -->
        <div class="question-block" id="s_q2">
            <div class="q-title">2. <span data-i18n="sQ2">您對藥師的服務態度滿意嗎？</span></div>
            <div class="radio-group" id="s_q2_opts"></div>
            <div class="error-msg" data-i18n="errAnswer">請作答</div>
        </div>

        <!-- Sat Q3 (Special Logic) -->
        <div class="question-block" id="s_q3">
            <div class="q-title">3. <span data-i18n="sQ3">下次若有用藥相關問題，您會不會再詢問藥師？</span></div>
            <div class="radio-group">
                <label class="radio-option"><input type="radio" name="s_q3" value="will" onclick="toggleQ3Input(false)"><span class="radio-circle"></span><span data-i18n="optWill">會</span></label>
                <label class="radio-option"><input type="radio" name="s_q3" value="wont" onclick="toggleQ3Input(false)"><span class="radio-circle"></span><span data-i18n="optWont">不會</span></label>
                <label class="radio-option"><input type="radio" name="s_q3" value="other" onclick="toggleQ3Input(true)"><span class="radio-circle"></span><span data-i18n="optOther">其他寶貴意見</span></label>
            </div>
            <input type="text" id="s_q3_other" placeholder="請填寫意見..." style="display:none; margin-top:10px;">
            <div class="error-msg" data-i18n="errAnswer">請作答</div>
        </div>

        <!-- Sat Q4 (Follow up) -->
        <div class="question-block" id="s_q4">
            <div style="font-size:0.8rem; color:#666; margin-bottom:8px; line-height:1.4;">
                <svg style="width:14px;height:14px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                <span data-i18n="disclaimer">為了確保用藥安全與服務品質，本院可能會在您接受衛教後進行電話追蹤訪談。所有資料將僅用於醫療品質改善，並依照個人資料保護法嚴格保密。感謝您的配合。</span>
            </div>
            <div class="q-title">4. <span data-i18n="sQ4">目前的用藥，您是否願意藥師為您進行後續的電訪追蹤？</span></div>
            <div class="radio-group">
                <label class="radio-option"><input type="radio" name="s_q4" value="yes" onclick="toggleFollowUp(true)"><span class="radio-circle"></span><span data-i18n="optYes">願意</span></label>
                <label class="radio-option"><input type="radio" name="s_q4" value="no" onclick="toggleFollowUp(false)"><span class="radio-circle"></span><span data-i18n="optNo">不願意</span></label>
            </div>
            
            <div id="followUpSection" class="hidden-section">
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="callTimeLabel">電訪時間</label>
                        <div class="radio-group">
                            <label class="radio-option"><input type="radio" name="callTime" value="am"><span class="radio-circle"></span>AM</label>
                            <label class="radio-option"><input type="radio" name="callTime" value="pm"><span class="radio-circle"></span>PM</label>
                            <label class="radio-option"><input type="radio" name="callTime" value="other"><span class="radio-circle"></span>Other</label>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="contactNameLabel">聯絡人</label>
                        <input type="text" id="contactName">
                    </div>
                    <div class="form-group">
                        <label data-i18n="contactPhoneLabel">聯絡電話</label>
                        <input type="tel" id="contactPhone" oninput="this.value = this.value.replace(/[^0-9+]/g, '')">
                    </div>
                </div>
            </div>
            <div class="error-msg" data-i18n="errAnswer">請作答</div>
        </div>

        <!-- 6. 簽名板 -->
        <div class="section-title">
            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            <span data-i18n="secSign">病人 / 代填者手寫簽名</span>
        </div>
        
        <div class="signature-wrapper" id="sigContainer">
            <canvas id="sigCanvas"></canvas>
            <button type="button" class="clear-sig-btn" onclick="clearSignature()" data-i18n="btnClearSign">清除簽名</button>
        </div>
        <div class="error-msg" id="sigError" style="text-align:center" data-i18n="errSign">請簽名</div>

        <!-- 隱私聲明 -->
        <div class="privacy-policy">
            【個人資料保護聲明】本問卷所蒐集之個人資料（包括但不限於病歷號、姓名、聯絡電話及簽名），將依據個人資料保護法及相關法令規定，僅供本院「提升門診用藥指導服務品質」、「學術研究」及「行政管理」等特定目的範圍內處理及利用。除經您書面同意外，本院不會將您的個人資料用於其他目的或提供予任何第三方。您有權向本院查詢、請求閱覽、複製、補充、更正、停止蒐集、處理、利用或刪除您的個人資料。若您不願提供，將可能影響本院提供您完整之用藥指導服務。
        </div>

        <!-- 按鈕區 -->
        <div class="action-buttons">
            <button type="button" class="btn btn-draft" onclick="handleAction('draft')">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                <span data-i18n="btnSaveDraft">暫存草稿</span>
            </button>
            <button type="button" class="btn btn-load" onclick="triggerLoad()">
                <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                <span data-i18n="btnLoadDraft">開啟草稿</span>
            </button>
            <button type="button" class="btn btn-submit" onclick="handleAction('finish')">
                <svg viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                <span data-i18n="btnFinish">完成</span>
            </button>
             <button type="button" class="btn btn-reset" onclick="resetAll()">
                <svg viewBox="0 0 24 24"><path d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4 7.58 4 4 7.58 4 12H1l4 4 4-4H6z"/></svg>
                <span data-i18n="btnReset">重置</span>
            </button>
        </div>
        
        <!-- 隱藏的檔案上傳輸入框 -->
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadFromFile(this)">
    </form>
</div>

<script>
    /**
     * 資料定義與多語系
     */
    const langData = {
        "tw": {
            mainTitle: "義大癌治療醫院門診用藥指導服務滿意度問卷",
            eduIdLabel: "衛教編號：",
            greetingText: "各位先生、女士：您好！癌治療醫院藥劑科為能提升更好的服務品質與顧客滿意度，敬請您協助填寫下列資料並並提供您的寶貴意見，以供我們參考與改進。 敬祝 平安   癌治療醫院藥劑科關心您",
            secBasic: "病人基本資料",
            fillerLabel: "填寫者",
            fillerSelf: "病人本人",
            fillerProxy: "代填",
            chartNoLabel: "病歷號 / 身分證號",
            nameLabel: "姓名",
            phoneLabel: "聯絡電話",
            eduLevelLabel: "教育程度",
            eduPri: "小學", eduJun: "國中", eduSen: "高中", eduCol: "大(專)", eduMas: "碩士以上", eduNone: "不識字",
            eduLangLabel: "衛教語言",
            secPharmacist: "衛教藥師區塊",
            pharmacistLabel: "衛教藥師",
            dateLabel: "衛教日期/時間",
            secMedicine: "衛教藥品選擇",
            secKnowledge: "藥物認知評估 (認知度)",
            preEdu: "衛教前", postEdu: "衛教後",
            kQ1: "您是否知道此藥物的作用？",
            kQ2: "您是否會使用或操作該藥物？",
            kQ3: "您是否知道該藥物使用時的注意事項？",
            secSat: "滿意度調查 (滿意度)",
            sQ1: "您對本院提供此用藥指導服務流程滿意嗎？",
            sQ2: "您對藥師的服務態度滿意嗎？",
            sQ3: "下次若有用藥相關問題，您會不會再詢問藥師？",
            optWill: "會", optWont: "不會", optOther: "其他寶貴意見",
            disclaimer: "為了確保用藥安全與服務品質，本院可能會在您接受衛教後進行電話追蹤訪談。所有資料將僅用於醫療品質改善，並依照個人資料保護法嚴格保密。感謝您的配合。",
            sQ4: "目前的用藥，您是否願意藥師為您進行後續的電訪追蹤？",
            optYes: "願意", optNo: "不願意",
            callTimeLabel: "電訪時間",
            contactNameLabel: "聯絡人",
            contactPhoneLabel: "聯絡電話",
            secSign: "病人 / 代填者手寫簽名",
            btnClearSign: "清除簽名",
            btnSaveDraft: "暫存草稿",
            btnLoadDraft: "開啟草稿",
            btnFinish: "完成",
            btnReset: "重置",
            errRequired: "此欄位必填/未完成",
            errChartNo: "請輸入英數字",
            errPhone: "格式錯誤 (至少6碼)",
            errAnswer: "請作答",
            errSign: "請簽名",
            knowledgeScale: ["非常清楚", "清楚", "尚可", "不清楚", "非常不清楚"],
            satisfactionScale: ["非常滿意", "滿意", "無意見", "不滿意", "非常不滿意"]
        },
        "en": {
            mainTitle: "Outpatient Medication Education Satisfaction Survey",
            eduIdLabel: "Edu ID: ",
            greetingText: "Dear Sir/Madam: To improve our service quality, please help us by filling out this form. Best regards, Pharmacy Dept.",
            secBasic: "Patient Information",
            fillerLabel: "Filled by",
            fillerSelf: "Self",
            fillerProxy: "Proxy",
            chartNoLabel: "Chart No. / ID No.",
            nameLabel: "Name",
            phoneLabel: "Phone",
            eduLevelLabel: "Education",
            eduPri: "Primary", eduJun: "Junior High", eduSen: "Senior High", eduCol: "College", eduMas: "Master+", eduNone: "Illiterate",
            eduLangLabel: "Language",
            secPharmacist: "Pharmacist Info",
            pharmacistLabel: "Pharmacist",
            dateLabel: "Date",
            secMedicine: "Medications",
            secKnowledge: "Medication Knowledge Assessment",
            preEdu: "Pre-Edu", postEdu: "Post-Edu",
            kQ1: "Do you know the purpose of this medication?",
            kQ2: "Do you know how to use/operate this medication?",
            kQ3: "Do you know the precautions for this medication?",
            secSat: "Satisfaction Survey",
            sQ1: "Are you satisfied with the medication education process?",
            sQ2: "Are you satisfied with the pharmacist's attitude?",
            sQ3: "Will you consult the pharmacist again for medication questions?",
            optWill: "Yes", optWont: "No", optOther: "Other comments",
            disclaimer: "We may follow up with a call to ensure safety. Data is confidential.",
            sQ4: "Are you willing to accept a follow-up phone call?",
            optYes: "Yes", optNo: "No",
            callTimeLabel: "Call Time",
            contactNameLabel: "Contact Person",
            contactPhoneLabel: "Contact Phone",
            secSign: "Signature",
            btnClearSign: "Clear",
            btnSaveDraft: "Save Draft",
            btnLoadDraft: "Load Draft",
            btnFinish: "Finish",
            btnReset: "Reset",
            errRequired: "Required",
            errChartNo: "Alphanumeric only",
            errPhone: "Format Error",
            errAnswer: "Please answer",
            errSign: "Please sign",
            knowledgeScale: ["Very Clear", "Clear", "Fair", "Unclear", "Very Unclear"],
            satisfactionScale: ["Very Satisfied", "Satisfied", "Neutral", "Dissatisfied", "Very Dissatisfied"]
        }
    };
    // 簡單擴充其他語言會重複 key，這裡僅實作 TW/EN 示範邏輯，其他語言選單可選但會顯示 EN fallback

    // 預設資料
    const defaultPharmacists = ["王大明", "李小花", "張志豪", "陳美麗"];
    const defaultMedicines = ["Aspirin", "Metformin", "Amlodipine", "Insulin", "Tylenol"];
    
    // 初始化
    let currentLang = 'tw';
    let canvas, ctx, isDrawing = false;
    
    document.addEventListener("DOMContentLoaded", () => {
        initCanvas();
        initData();
        renderQuestions();
        document.getElementById('eduDate').valueAsDate = new Date();
    });

    function changeLanguage() {
        const sel = document.getElementById('langSelect').value;
        currentLang = (langData[sel]) ? sel : 'en'; // Fallback
        
        // Update static text
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(langData[currentLang][key]) {
                el.innerText = langData[currentLang][key];
            }
        });
        
        // Re-render questions to update labels
        renderQuestions();
    }

    function initData() {
        // Load Pharmacists
        let savedPharma = JSON.parse(localStorage.getItem('savedPharmacists')) || defaultPharmacists;
        renderPharmacistSelect(savedPharma);
        
        // Load Medicines
        let savedMeds = JSON.parse(localStorage.getItem('savedMedicines')) || defaultMedicines;
        renderMedicineList(savedMeds);
    }

    // --- UI Logic ---

    function syncEduId(input) {
        document.getElementById('eduIdDisplay').innerText = input.value.toUpperCase();
    }

    function toggleProxyInput(show) {
        document.getElementById('proxyRelation').style.display = show ? 'block' : 'none';
    }

    function toggleQ3Input(show) {
        document.getElementById('s_q3_other').style.display = show ? 'block' : 'none';
    }

    function toggleFollowUp(show) {
        document.getElementById('followUpSection').style.display = show ? 'block' : 'none';
    }

    function renderPharmacistSelect(list) {
        const sel = document.getElementById('pharmacistSelect');
        sel.innerHTML = '';
        list.forEach(p => {
            let opt = document.createElement('option');
            opt.value = p;
            opt.text = p;
            sel.appendChild(opt);
        });
    }

    function addPharmacist() {
        const name = prompt("輸入藥師姓名：");
        if(name) {
            let list = JSON.parse(localStorage.getItem('savedPharmacists')) || defaultPharmacists;
            list.push(name);
            localStorage.setItem('savedPharmacists', JSON.stringify(list));
            renderPharmacistSelect(list);
            document.getElementById('pharmacistSelect').value = name;
        }
    }

    function removePharmacist() {
        const sel = document.getElementById('pharmacistSelect');
        if(sel.selectedIndex >= 0) {
            let list = JSON.parse(localStorage.getItem('savedPharmacists')) || defaultPharmacists;
            list = list.filter(n => n !== sel.value);
            localStorage.setItem('savedPharmacists', JSON.stringify(list));
            renderPharmacistSelect(list);
        }
    }

    function renderMedicineList(list) {
        const container = document.getElementById('medicineListContainer');
        container.innerHTML = '';
        list.forEach((m, idx) => {
            const div = document.createElement('div');
            div.className = 'radio-option'; // Using radio style for checkboxes visually
            div.innerHTML = `
                <input type="checkbox" name="medicines" value="${m}" id="med_${idx}" style="display:none">
                <label for="med_${idx}" style="display:flex;align-items:center;cursor:pointer">
                    <span class="radio-circle" style="border-radius:4px"></span>
                    ${m}
                </label>
                <span onclick="deleteMed('${m}')" style="margin-left:5px;cursor:pointer;color:#999;font-size:0.8em">✕</span>
            `;
            // Checkbox logic for visual
            const chk = div.querySelector('input');
            chk.addEventListener('change', function() {
                const circle = this.nextElementSibling.querySelector('.radio-circle');
                if(this.checked) {
                    circle.style.background = 'linear-gradient(45deg, var(--medical-blue), var(--tech-green))';
                    circle.style.border = 'none';
                } else {
                    circle.style.background = 'transparent';
                    circle.style.border = '2px solid var(--medical-blue)';
                }
            });
            container.appendChild(div);
        });
    }

    function addMedicine() {
        const name = prompt("輸入藥品名稱：");
        if(name) {
            let list = JSON.parse(localStorage.getItem('savedMedicines')) || defaultMedicines;
            list.push(name);
            localStorage.setItem('savedMedicines', JSON.stringify(list));
            renderMedicineList(list);
        }
    }
    window.deleteMed = function(name) {
        if(confirm(`刪除 ${name}?`)) {
            let list = JSON.parse(localStorage.getItem('savedMedicines')) || defaultMedicines;
            list = list.filter(m => m !== name);
            localStorage.setItem('savedMedicines', JSON.stringify(list));
            renderMedicineList(list);
        }
    }

    function renderQuestions() {
        const kOpts = langData[currentLang].knowledgeScale;
        const sOpts = langData[currentLang].satisfactionScale;

        // Knowledge Render Helper
        const renderRadioGroup = (id, name, opts) => {
            const container = document.getElementById(id);
            container.innerHTML = '';
            opts.forEach((txt, idx) => {
                const label = document.createElement('label');
                label.className = 'radio-option';
                label.innerHTML = `
                    <input type="radio" name="${name}" value="${5-idx}">
                    <span class="radio-circle"></span>
                    <span>${txt}</span>
                `;
                container.appendChild(label);
            });
        };

        renderRadioGroup('k_q1_pre', 'k_q1_pre', kOpts);
        renderRadioGroup('k_q1_post', 'k_q1_post', kOpts);
        renderRadioGroup('k_q2_pre', 'k_q2_pre', kOpts);
        renderRadioGroup('k_q2_post', 'k_q2_post', kOpts);
        renderRadioGroup('k_q3_pre', 'k_q3_pre', kOpts);
        renderRadioGroup('k_q3_post', 'k_q3_post', kOpts);

        // Satisfaction
        renderRadioGroup('s_q1_opts', 's_q1', sOpts);
        renderRadioGroup('s_q2_opts', 's_q2', sOpts);
    }

    // --- Canvas Signature ---

    function initCanvas() {
        canvas = document.getElementById('sigCanvas');
        ctx = canvas.getContext('2d');
        
        // High DPI scaling
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        ctx.scale(ratio, ratio);
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';

        // Mouse Events
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('mouseout', stopDraw);
        
        // Touch Events
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e.touches[0]); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
        canvas.addEventListener('touchend', stopDraw);
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }

    function startDraw(e) {
        isDrawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        // Mark as dirty
        canvas.setAttribute('data-dirty', 'true');
    }

    function draw(e) {
        if(!isDrawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    function stopDraw() {
        isDrawing = false;
        ctx.closePath();
    }

    function clearSignature() {
        ctx.clearRect(0, 0, canvas.width / window.devicePixelRatio, canvas.height / window.devicePixelRatio);
        canvas.removeAttribute('data-dirty');
    }

    function isSignatureEmpty() {
        return !canvas.hasAttribute('data-dirty');
    }

    // --- Validation & Actions ---

    function validate(mode) {
        // Clear previous errors
        document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));

        let errors = [];

        // 1. Basic Info (Always check for Draft & Finish if data present, but strictly for Finish)
        const filler = document.querySelector('input[name="filler"]:checked');
        if(!filler) errors.push({id: 'fillerGroup', msg: 'required'});
        
        const chart = document.getElementById('chartNo');
        if(!chart.value) errors.push({id: 'chartNo', msg: 'required'});
        
        const name = document.getElementById('patientName');
        if(!name.value) errors.push({id: 'patientName', msg: 'required'});
        
        const phone = document.getElementById('patientPhone');
        if(!phone.value || phone.value.length < 6) errors.push({id: 'patientPhone', msg: 'format'});

        // Check Signature
        if(isSignatureEmpty()) {
            errors.push({id: 'sigContainer', msg: 'sign'});
        }

        // 2. Full check for 'finish'
        if(mode === 'finish') {
            // Check all radio groups
            const checkRadio = (name, containerId) => {
                if(!document.querySelector(`input[name="${name}"]:checked`)) {
                    errors.push({id: containerId, msg: 'answer'});
                }
            };

            checkRadio('k_q1_pre', 'k_q1'); checkRadio('k_q1_post', 'k_q1');
            checkRadio('k_q2_pre', 'k_q2'); checkRadio('k_q2_post', 'k_q2');
            checkRadio('k_q3_pre', 'k_q3'); checkRadio('k_q3_post', 'k_q3');
            
            checkRadio('s_q1', 's_q1');
            checkRadio('s_q2', 's_q2');
            checkRadio('s_q3', 's_q3');
            checkRadio('s_q4', 's_q4');
        }

        if(errors.length > 0) {
            // Show errors and scroll
            errors.forEach(err => {
                const el = document.getElementById(err.id);
                if(el) {
                    const parent = el.closest('.form-group') || el.closest('.question-block') || el.closest('.signature-wrapper');
                    if(parent) {
                        parent.classList.add('has-error');
                        // Ensure error message is visible
                        const msg = parent.querySelector('.error-msg');
                        if(msg) msg.style.display = 'block';
                    }
                }
            });
            // Scroll to first error
            const firstErr = document.getElementById(errors[0].id);
            if(firstErr) firstErr.scrollIntoView({behavior: 'smooth', block: 'center'});
            return false;
        }
        return true;
    }

    function getFormData() {
        const getVal = (id) => document.getElementById(id).value;
        const getRadio = (name) => {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? el.value : '';
        };
        const getChecks = (name) => {
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(c => c.value);
        };

        return {
            eduId: getVal('chartNo'),
            lang: currentLang,
            date: getVal('eduDate'),
            filler: getRadio('filler'),
            proxyRel: getVal('proxyRelation'),
            chartNo: getVal('chartNo'),
            patientName: getVal('patientName'),
            patientPhone: getVal('patientPhone'),
            eduLevel: getRadio('eduLevel'),
            eduLang: getVal('eduLang'),
            pharmacist: getVal('pharmacistSelect'),
            medicines: getChecks('medicines'),
            k_q1_pre: getRadio('k_q1_pre'), k_q1_post: getRadio('k_q1_post'),
            k_q2_pre: getRadio('k_q2_pre'), k_q2_post: getRadio('k_q2_post'),
            k_q3_pre: getRadio('k_q3_pre'), k_q3_post: getRadio('k_q3_post'),
            s_q1: getRadio('s_q1'),
            s_q2: getRadio('s_q2'),
            s_q3: getRadio('s_q3'), s_q3_other: getVal('s_q3_other'),
            s_q4: getRadio('s_q4'),
            callTime: getRadio('callTime'),
            contactName: getVal('contactName'),
            contactPhone: getVal('contactPhone'),
            signature: isSignatureEmpty() ? '' : canvas.toDataURL()
        };
    }

    function setFormData(data) {
        if(!data) return;
        
        const setVal = (id, v) => { if(document.getElementById(id)) document.getElementById(id).value = v || ''; };
        const setRadio = (name, v) => {
            const el = document.querySelector(`input[name="${name}"][value="${v}"]`);
            if(el) { el.checked = true; el.click(); } // click triggers UI logic
        };
        
        currentLang = data.lang || 'tw';
        document.getElementById('langSelect').value = currentLang;
        changeLanguage();

        setVal('chartNo', data.chartNo); syncEduId(document.getElementById('chartNo'));
        setVal('patientName', data.patientName);
        setVal('patientPhone', data.patientPhone);
        setVal('proxyRelation', data.proxyRel);
        setVal('eduDate', data.date);
        setVal('eduLang', data.eduLang);
        setVal('pharmacistSelect', data.pharmacist);
        setVal('s_q3_other', data.s_q3_other);
        setVal('contactName', data.contactName);
        setVal('contactPhone', data.contactPhone);

        setRadio('filler', data.filler);
        setRadio('eduLevel', data.eduLevel);
        setRadio('k_q1_pre', data.k_q1_pre); setRadio('k_q1_post', data.k_q1_post);
        setRadio('k_q2_pre', data.k_q2_pre); setRadio('k_q2_post', data.k_q2_post);
        setRadio('k_q3_pre', data.k_q3_pre); setRadio('k_q3_post', data.k_q3_post);
        setRadio('s_q1', data.s_q1);
        setRadio('s_q2', data.s_q2);
        setRadio('s_q3', data.s_q3);
        setRadio('s_q4', data.s_q4);
        if(data.callTime) setRadio('callTime', data.callTime);

        // Medicines
        if(data.medicines) {
            data.medicines.forEach(m => {
                const cb = document.querySelector(`input[value="${m}"]`);
                if(cb) { cb.checked = true; cb.dispatchEvent(new Event('change')); }
            });
        }

        // Signature
        if(data.signature) {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width/window.devicePixelRatio, canvas.height/window.devicePixelRatio);
                canvas.setAttribute('data-dirty', 'true');
            }
            img.src = data.signature;
        }
    }

    async function handleAction(type) {
        if(type === 'draft') {
            // Check basic fields only, but allow saving anyway after alert? 
            // Request says: "Check basic info/sig, if missing show red but allow draft?" 
            // Request says: "If missing... display red text... scroll to field."
            if(!validate('draft')) return; 

            const data = getFormData();
            const json = JSON.stringify(data);
            const key = `medSurveyDraft_${data.chartNo}_${Date.now()}`;
            
            // Save to LocalStorage
            localStorage.setItem(key, json);
            localStorage.setItem('lastDraftKey', key); // Easy retrieve

            // Download JSON
            const blob = new Blob([json], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `survey_draft_${data.chartNo}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            alert("草稿已儲存並下載！");

        } else if (type === 'finish') {
            if(!validate('finish')) return;

            const choice = confirm("表單檢查完成！\n按「確定」匯出 PDF，按「取消」匯出 Excel。\n(實際上您可以都選擇，這裡做示範分流)");
            
            // Generate Filename
            const data = getFormData();
            const filename = `Survey_${data.chartNo}_${data.date}`;

            // Hide buttons for export
            const btns = document.querySelector('.action-buttons');
            btns.style.display = 'none';

            if(choice) {
                // PDF Export
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const element = document.getElementById('surveyForm');
                
                // Use html2canvas
                await html2canvas(element, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210; 
                    const pageHeight = 295; 
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    doc.save(filename + '.pdf');
                });
            } else {
                // Excel Export
                const wb = XLSX.utils.book_new();
                
                // Transform data for readability
                const flatData = [
                    ["欄位", "內容"],
                    ["衛教編號", data.eduId],
                    ["姓名", data.patientName],
                    ["病歷號", data.chartNo],
                    ["認知-Q1(前)", data.k_q1_pre ? langData['tw'].knowledgeScale[5-data.k_q1_pre] : ''],
                    ["認知-Q1(後)", data.k_q1_post ? langData['tw'].knowledgeScale[5-data.k_q1_post] : ''],
                    ["滿意度-Q1", data.s_q1 ? langData['tw'].satisfactionScale[5-data.s_q1] : ''],
                    // ... add all fields mapped ...
                    ["簽名(Base64)", data.signature ? "有 (見附檔或資料)" : "無"]
                ];

                const ws = XLSX.utils.aoa_to_sheet(flatData);
                XLSX.utils.book_append_sheet(wb, ws, "SurveyData");
                XLSX.writeFile(wb, filename + '.xlsx');
            }

            // Restore buttons
            btns.style.display = 'flex';
        }
    }

    function triggerLoad() {
        // Option 1: LocalStorage check
        const lastKey = localStorage.getItem('lastDraftKey');
        let fromLocal = false;
        
        if(lastKey && confirm("發現最近的自動存檔，要從瀏覽器紀錄載入嗎？\n(按取消則選擇上傳檔案)")) {
            const json = localStorage.getItem(lastKey);
            if(json) {
                setFormData(JSON.parse(json));
                fromLocal = true;
            }
        }
        
        if(!fromLocal) {
            document.getElementById('fileInput').click();
        }
    }

    function loadFromFile(input) {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                setFormData(data);
            } catch(err) {
                alert("檔案格式錯誤");
            }
        };
        reader.readAsText(file);
        input.value = ''; // reset
    }

    function resetAll() {
        if(confirm("確定要重置所有內容嗎？此操作無法復原。")) {
            document.getElementById('mainForm').reset();
            clearSignature();
            document.getElementById('eduIdDisplay').innerText = '';
            document.getElementById('medicineListContainer').innerHTML = '';
            initData(); // reload lists
            // Reset state
            document.querySelectorAll('.error-msg').forEach(e => e.style.display='none');
            document.querySelectorAll('.has-error').forEach(e => e.classList.remove('has-error'));
            document.querySelectorAll('.radio-circle').forEach(c => {
                c.style.background = 'transparent'; 
                c.style.border = '2px solid var(--medical-blue)';
            });
            // Clear storage draft
            const lastKey = localStorage.getItem('lastDraftKey');
            if(lastKey) localStorage.removeItem(lastKey);
        }
    }
</script>

</body>
</html>